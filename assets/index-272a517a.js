import{w as L,aZ as M,q as D,j as e,r as u,aW as g,P as V,d as T,f,h as E,v as P,bn as $}from"./index-b28ba44c.js";import{u as U}from"./useQuery-3baf8eda.js";import{u as B}from"./useMutation-97f0dbcf.js";import{B as O}from"./ButtonGroup-e3119c45.js";import{B as v}from"./Button-31e96e58.js";import{S as k}from"./Spinner-9d2d648a.js";import{A as Q}from"./Alert-1b0c81c4.js";import{M as y}from"./Modal-739a33da.js";const K="https://api.dev.usta.vn",b=L.create({baseURL:`${K}/api`,timeout:3e4,headers:{"Content-Type":"application/json"}});b.interceptors.request.use(async s=>{const i=localStorage.getItem("_USTA_OAUTH");if(i)try{const a=JSON.parse(i);s.headers.Authorization=`Bearer ${a.accessToken}`,console.log("[Technician API] Request:",{method:s.method,url:s.url,params:s.params,hasAuth:!!s.headers.Authorization})}catch(a){console.error("[Technician API] Failed to parse OAuth session:",a)}else console.warn("[Technician API] No OAuth session found");return s},s=>(console.error("[Technician API] Request error:",s),Promise.reject(s)));b.interceptors.response.use(s=>(console.log("[Technician API] Response:",{status:s.status,url:s.config.url,data:s.data}),s),s=>{var i,a,r;return console.error("[Technician API] Response error:",{status:(i=s.response)==null?void 0:i.status,url:(a=s.config)==null?void 0:a.url,data:(r=s.response)==null?void 0:r.data,message:s.message}),Promise.reject(s)});async function _(s={}){console.log("[Technician API] Fetching technicians:",s);const i=await b.get("/technicians/",{params:s});if(i.data.success)return i.data.data;throw new Error(i.data.error||"Failed to fetch technicians")}async function G(s){var i,a,r,t;console.log("[Technician API] Approving technician:",s);try{const{technicianId:c,...m}=s,d=await b.post(`/technicians/${c}/approve`,m);if(d.data.success&&d.data.data)return d.data.data;throw new Error(d.data.error||d.data.message||"Failed to approve technician")}catch(c){console.error("[Technician API] Error approving technician:",c);const m=((a=(i=c.response)==null?void 0:i.data)==null?void 0:a.error)||((t=(r=c.response)==null?void 0:r.data)==null?void 0:t.message)||c.message||"Failed to approve technician";throw new Error(m)}}async function Z(s){var i,a,r,t;console.log("[Technician API] Rejecting technician:",s);try{const{technicianId:c,reason:m}=s,d=await b.post(`/technicians/${c}/reject`,{reason:m});if(!d.data.success)throw new Error(d.data.error||d.data.message||"Failed to reject technician")}catch(c){console.error("[Technician API] Error rejecting technician:",c);const m=((a=(i=c.response)==null?void 0:i.data)==null?void 0:a.error)||((t=(r=c.response)==null?void 0:r.data)==null?void 0:t.message)||c.message||"Failed to reject technician";throw new Error(m)}}function J(s={}){return U({queryKey:["technicians",s],queryFn:()=>_(s),staleTime:3e4,retry:2,select:i=>i||[]})}function W(){const s=M(),{showNotification:i}=D();return B({mutationFn:a=>G(a),onSuccess:()=>{s.invalidateQueries({queryKey:["technicians"]}),i({message:"Technician approved successfully",type:"success"})},onError:a=>{const r=(a==null?void 0:a.message)||"Failed to approve technician";i({message:r,type:"error"})}})}function X(){const s=M(),{showNotification:i}=D();return B({mutationFn:a=>Z(a),onSuccess:()=>{s.invalidateQueries({queryKey:["technicians"]}),i({message:"Technician rejected successfully",type:"success"})},onError:a=>{const r=(a==null?void 0:a.message)||"Failed to reject technician";i({message:r,type:"error"})}})}const Y=({onApprove:s,onReject:i,onViewDetail:a,processingId:r,isApproving:t,isRejecting:c,needsApproval:m,getStatusBadge:d,getRatingStars:N})=>[{Header:"Name",accessor:"name",defaultCanSort:!0,Cell:({row:l})=>{const o=l.original;return e.jsxs("div",{children:[e.jsx("strong",{children:o.name}),o.address&&e.jsx("div",{className:"text-muted small",children:o.address})]})}},{Header:"Phone",accessor:"phone",defaultCanSort:!0},{Header:"Email",accessor:"email",defaultCanSort:!0,Cell:({value:l})=>l||e.jsx("span",{className:"text-muted",children:"-"})},{Header:"Specialization",accessor:"specialization",defaultCanSort:!1,Cell:({value:l})=>l||e.jsx("span",{className:"text-muted",children:"-"})},{Header:"Rating",accessor:"rating",defaultCanSort:!0,Cell:({row:l})=>{const o=l.original;return N(o.rating)}},{Header:"Status",accessor:"status",defaultCanSort:!0,Cell:({row:l})=>{const o=l.original;return d(o.status)}},{Header:"Created At",accessor:"createdAt",defaultCanSort:!0,Cell:({value:l})=>new Date(l).toLocaleDateString("vi-VN")},{Header:"Actions",accessor:"id",defaultCanSort:!1,Cell:({row:l})=>{const o=l.original,j=r===o.id,x=m(o);return e.jsx("div",{className:"d-flex gap-1",children:e.jsxs(O,{size:"sm",className:"gap-1",children:[e.jsx(v,{variant:"info",onClick:p=>{p.stopPropagation(),a(o)},title:"View Details",children:e.jsx("i",{className:"mdi mdi-eye"})}),x&&e.jsxs(e.Fragment,{children:[e.jsx(v,{variant:"success",onClick:p=>{p.stopPropagation(),s(o)},disabled:j,title:"Approve",children:j&&t?e.jsxs(e.Fragment,{children:[e.jsx(k,{animation:"border",size:"sm",className:"me-1"}),"Approving..."]}):"Approve"}),e.jsx(v,{variant:"danger",onClick:p=>{p.stopPropagation(),i(o)},disabled:j,title:"Reject",children:j&&c?e.jsxs(e.Fragment,{children:[e.jsx(k,{animation:"border",size:"sm",className:"me-1"}),"Rejecting..."]}):"Reject"})]})]})})}}],ee=[{text:"10",value:10},{text:"25",value:25},{text:"50",value:50},{text:"100",value:100}],se=()=>{const[s,i]=u.useState(void 0),[a,r]=u.useState(null),[t,c]=u.useState(null),[m,d]=u.useState(!1),{data:N=[],isLoading:l,error:o,refetch:j}=J(s!==void 0?{status:s}:{}),x=W(),p=X(),w=u.useCallback(n=>{switch(n){case 1:return e.jsx(g,{bg:"info",children:"Pending"});case 2:return e.jsx(g,{bg:"success",children:"Approved"});case 3:return e.jsx(g,{bg:"danger",children:"Rejected"});default:return e.jsx(g,{bg:"secondary",children:"Unknown"})}},[]),A=u.useCallback(n=>n.status===1,[]),I=u.useCallback(async n=>{if(!A(n))return;const h=n.name||n.phone||n.id||"this technician";if(window.confirm(`Are you sure you want to approve ${h}?`)){r(n.id);try{await x.mutateAsync({technicianId:n.id,profileId:n.profileId,skills:n.skills,zones:n.zones})}catch(C){console.error("Failed to approve technician:",C)}finally{r(null)}}},[A,x]),F=u.useCallback(async n=>{const h=n.name||n.phone||n.id||"this technician",C=window.prompt(`Enter reason for rejecting ${h} (optional):`);if(C!==null&&window.confirm(`Are you sure you want to reject ${h}?`)){r(n.id);try{await p.mutateAsync({technicianId:n.id,reason:C||void 0})}catch(H){console.error("Failed to reject technician:",H)}finally{r(null)}}},[p]),S=u.useCallback(n=>{if(!n)return e.jsx("span",{className:"text-muted",children:"No rating"});const h="â­".repeat(Math.round(n));return e.jsxs("span",{children:[h," (",n.toFixed(1),")"]})},[]),R=u.useCallback(n=>{c(n),d(!0)},[]),z=u.useCallback(()=>{d(!1),c(null)},[]),q=u.useMemo(()=>Y({onApprove:I,onReject:F,onViewDetail:R,processingId:a,isApproving:x.isPending,isRejecting:p.isPending,needsApproval:A,getStatusBadge:w,getRatingStars:S}),[I,F,R,a,x.isPending,p.isPending,A,w,S]);return e.jsxs(e.Fragment,{children:[e.jsx(V,{title:"Technician Management",subName:"Apps"}),e.jsx(T,{children:e.jsx(f,{xs:12,children:e.jsx(E,{children:e.jsxs(E.Body,{children:[e.jsx(T,{className:"mb-3",children:e.jsx(f,{md:4,children:e.jsxs(P.Group,{children:[e.jsx(P.Label,{children:"Filter by Status"}),e.jsxs(P.Select,{value:s??"",onChange:n=>{const h=n.target.value;i(h===""?void 0:Number(h))},children:[e.jsx("option",{value:"",children:"All"}),e.jsx("option",{value:1,children:"Pending"}),e.jsx("option",{value:2,children:"Approved"}),e.jsx("option",{value:3,children:"Rejected"})]})]})})}),o&&e.jsxs(Q,{variant:"danger",dismissible:!0,children:["Failed to load technicians: ",o.message,e.jsx(v,{variant:"link",onClick:()=>j(),children:"Try Again"})]}),l?e.jsxs("div",{className:"text-center py-5",children:[e.jsx(k,{animation:"border",variant:"primary"}),e.jsx("p",{className:"mt-2",children:"Loading technicians..."})]}):N&&N.length>0?e.jsx($,{columns:q,data:N,pageSize:10,sizePerPageList:ee,isSortable:!0,pagination:!0,isSearchable:!0,theadClass:"table-light"}):e.jsxs("div",{className:"text-center py-5",children:[e.jsx("p",{className:"text-muted",children:"No technicians found"}),e.jsx(v,{variant:"link",onClick:()=>j(),children:"Try Again"})]})]})})})}),e.jsxs(y,{show:m,onHide:z,size:"lg",children:[e.jsx(y.Header,{closeButton:!0,children:e.jsx(y.Title,{children:"Technician Details"})}),e.jsx(y.Body,{children:t?e.jsxs(T,{children:[e.jsxs(f,{md:6,children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Name:"}),e.jsx("p",{className:"mb-0",children:t.name})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Phone:"}),e.jsx("p",{className:"mb-0",children:t.phone})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Email:"}),e.jsx("p",{className:"mb-0",children:t.email||e.jsx("span",{className:"text-muted",children:"-"})})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Address:"}),e.jsx("p",{className:"mb-0",children:t.address||e.jsx("span",{className:"text-muted",children:"-"})})]})]}),e.jsxs(f,{md:6,children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Status:"}),e.jsx("p",{className:"mb-0",children:w(t.status)})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Specialization:"}),e.jsx("p",{className:"mb-0",children:t.specialization||e.jsx("span",{className:"text-muted",children:"-"})})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Rating:"}),e.jsx("p",{className:"mb-0",children:S(t.rating)})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Created At:"}),e.jsx("p",{className:"mb-0",children:new Date(t.createdAt).toLocaleDateString("vi-VN",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})})]}),t.updatedAt&&e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Updated At:"}),e.jsx("p",{className:"mb-0",children:new Date(t.updatedAt).toLocaleDateString("vi-VN",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})})]})]}),t.profileId&&e.jsxs(f,{xs:12,children:[e.jsx("hr",{}),e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Profile ID:"}),e.jsx("p",{className:"mb-0 text-muted small",children:t.profileId})]}),t.skills&&t.skills.length>0&&e.jsxs("div",{className:"mb-2",children:[e.jsxs("strong",{children:["Skills (",t.skills.length,"):"]}),e.jsx("div",{className:"mt-1",children:t.skills.map((n,h)=>e.jsx(g,{bg:"primary",className:"me-1",children:n},h))})]}),t.zones&&t.zones.length>0&&e.jsxs("div",{className:"mb-2",children:[e.jsxs("strong",{children:["Zones (",t.zones.length,"):"]}),e.jsx("div",{className:"mt-1",children:t.zones.map((n,h)=>e.jsx(g,{bg:"info",className:"me-1",children:n},h))})]})]})]}):null}),e.jsx(y.Footer,{children:e.jsx(v,{variant:"secondary",onClick:z,children:"Close"})})]})]})},de=()=>e.jsx(se,{});export{de as default};
