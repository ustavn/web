import{r as d,z as M,j as e,l as V,a3 as ne,a4 as ie,d as k,f as N,a5 as J,P as oe,h as Y,L as ce}from"./index-c947d73c.js";import{a as le,u as de}from"./useBookings-91e7e3fe.js";import{u as me}from"./useTechnicians-35f3a734.js";import{u as ue}from"./useProducts-c484a35f.js";import{F as a}from"./Form-e8afece7.js";import{A as $}from"./Alert-8dbb89a3.js";import{S as _}from"./Spinner-385056f3.js";import{B as j}from"./Button-3c824970.js";import{M as E}from"./Modal-a0be62a7.js";import{g as he}from"./statusUtils-1ccce17b.js";import{a as xe}from"./hook-20466ebe.js";import{u as ge,B as pe}from"./Nav-b8099066.js";import{N as je}from"./NavbarContext-22c2b4c3.js";import{m as fe}from"./NavContext-882c4da5.js";import{B as z}from"./Badge-5adff270.js";import{I as D}from"./InputGroup-e269d219.js";import{B as ve}from"./ButtonGroup-60f3627d.js";import"./useQuery-e382baee.js";import"./useMutation-1e28e3fa.js";import"./AbstractModalHeader-908d2567.js";import"./useWindow-e0ec882a.js";import"./hasClass-6653d1f3.js";import"./useMergedRefs-73da3a82.js";import"./DataKey-e12315fd.js";import"./InputGroupContext-187f324a.js";const Z=d.forwardRef(({className:i,bsPrefix:n,as:g="div",...h},o)=>(n=M(n,"nav-item"),e.jsx(g,{ref:o,className:V(i,n),...h})));Z.displayName="NavItem";const Ne=Z,W=d.forwardRef(({bsPrefix:i,className:n,as:g=ne,active:h,eventKey:o,disabled:c=!1,...p},x)=>{i=M(i,"nav-link");const[f,m]=ge({key:fe(o,p.href),active:h,disabled:c,...p});return e.jsx(g,{...p,...f,ref:x,disabled:c,className:V(n,i,c&&"disabled",m.isActive&&"active")})});W.displayName="NavLink";const be=W,X=d.forwardRef((i,n)=>{const{as:g="div",bsPrefix:h,variant:o,fill:c=!1,justify:p=!1,navbar:x,navbarScroll:f,className:m,activeKey:r,...l}=xe(i,{activeKey:"onSelect"}),u=M(h,"nav");let v,b,y=!1;const S=d.useContext(je),w=d.useContext(ie);return S?(v=S.bsPrefix,y=x??!0):w&&({cardHeaderBsPrefix:b}=w),e.jsx(pe,{as:g,ref:n,activeKey:r,className:V(m,{[u]:!y,[`${v}-nav`]:y,[`${v}-nav-scroll`]:y&&f,[`${b}-${o}`]:!!b,[`${u}-${o}`]:!!o,[`${u}-fill`]:c,[`${u}-justified`]:p}),...l})});X.displayName="Nav";const C=Object.assign(X,{Item:Ne,Link:be});let G=!1,L=!1;const F=[],ye=({onPlaceSelected:i,value:n="",placeholder:g="Search for an address",required:h=!1})=>{const o=d.useRef(null),c=d.useRef(null);return d.useEffect(()=>{o.current&&n&&(o.current.value=n)},[n]),d.useEffect(()=>{const p="AIzaSyDJvwpR_epAanY-ayIYf8AZmjUu2IgFpdc",x=()=>{if(!o.current){setTimeout(x,100);return}if(!window.google||!window.google.maps||!window.google.maps.places){setTimeout(x,200);return}try{c.current&&google.maps.event.clearInstanceListeners(c.current);const m={types:["geocode","establishment"],componentRestrictions:{country:"vn"},fields:["formatted_address","geometry","name"]};c.current=new google.maps.places.Autocomplete(o.current,m),setTimeout(()=>{document.querySelector(".pac-container")},1e3),c.current.addListener("place_changed",()=>{var u;const r=(u=c.current)==null?void 0:u.getPlace();if(!r||!r.geometry||!r.geometry.location)return;const l={address:r.formatted_address||"",latitude:r.geometry.location.lat(),longitude:r.geometry.location.lng()};o.current&&(o.current.value=l.address),i(l)})}catch{}};return(()=>{if(G||window.google&&window.google.maps&&window.google.maps.places){G=!0,x();return}if(L){F.push(x);return}const m=document.querySelector('script[src*="maps.googleapis.com"]');if(m){L=!0,m.addEventListener("load",()=>{G=!0,L=!1,x(),F.forEach(u=>u()),F.length=0});return}const r=`https://maps.googleapis.com/maps/api/js?key=${p}&libraries=places`;L=!0;const l=document.createElement("script");l.src=r,l.async=!0,l.defer=!0,l.onload=()=>{G=!0,L=!1,x(),F.forEach(u=>u()),F.length=0},l.onerror=()=>{L=!1},document.head.appendChild(l)})(),()=>{if(c.current&&window.google&&window.google.maps)try{google.maps.event.clearInstanceListeners(c.current)}catch{}}},[i]),e.jsxs(e.Fragment,{children:[e.jsx("style",{children:`
				.pac-container {
					z-index: 9999 !important;
					position: fixed !important;
				}
			`}),e.jsx("div",{style:{position:"relative"},children:e.jsx(a.Control,{ref:o,type:"text",defaultValue:n,placeholder:g,required:h,autoComplete:"off",id:"google-places-autocomplete-input"})})]})},Ce=({initialData:i,products:n,productsLoading:g=!1,onSubmit:h,onCancel:o,isSubmitting:c=!1,error:p,submitButtonText:x="Submit",cancelButtonText:f="Cancel",showCancelButton:m=!0})=>{const[r,l]=d.useState({bookingTime:"",customerId:"",customerName:"",customerPhone:"",latitude:0,longitude:0,address:"",items:[],...i}),[u,v]=d.useState(""),[b,y]=d.useState(1);d.useEffect(()=>{i&&(l(t=>({...t,...i})),i.items&&i.items.length>0&&(v(i.items[0].productId),y(i.items[0].quantity)))},[i]);const S=t=>{l(T=>({...T,address:t.address,latitude:t.latitude,longitude:t.longitude}))},w=t=>{if(t.preventDefault(),!u)return;const T={...r,bookingTime:r.bookingTime?new Date(r.bookingTime).toISOString():new Date().toISOString(),items:[{productId:u,quantity:b}]};h(T)},B=n.find(t=>t.id===u);return e.jsxs(a,{onSubmit:w,children:[p&&e.jsx($,{variant:"danger",dismissible:!0,children:p}),e.jsxs(k,{children:[e.jsx(N,{md:6,children:e.jsxs(a.Group,{className:"mb-3",children:[e.jsx(a.Label,{children:"Customer Name *"}),e.jsx(a.Control,{type:"text",placeholder:"Enter customer name",value:r.customerName||"",onChange:t=>l({...r,customerName:t.target.value}),required:!0})]})}),e.jsx(N,{md:6,children:e.jsxs(a.Group,{className:"mb-3",children:[e.jsx(a.Label,{children:"Customer Phone *"}),e.jsx(a.Control,{type:"tel",placeholder:"0352978519",value:r.customerPhone||"",onChange:t=>l({...r,customerPhone:t.target.value}),required:!0})]})})]}),e.jsxs(a.Group,{className:"mb-3",children:[e.jsx(a.Label,{children:"Customer ID *"}),e.jsx(a.Control,{type:"text",placeholder:"Enter customer ID (UUID)",value:r.customerId||"",onChange:t=>l({...r,customerId:t.target.value}),required:!0})]}),e.jsxs(a.Group,{className:"mb-3",children:[e.jsx(a.Label,{children:"Address *"}),e.jsx(ye,{value:r.address||"",onPlaceSelected:S,placeholder:"Search for an address using Google Maps",required:!0})]}),r.latitude!==0&&r.longitude!==0&&e.jsx($,{variant:"info",className:"mb-3",children:e.jsxs("small",{children:[e.jsx("strong",{children:"Coordinates:"})," ",r.latitude.toFixed(6),", ",r.longitude.toFixed(6)]})}),e.jsxs(a.Group,{className:"mb-3",children:[e.jsx(a.Label,{children:"Booking Time *"}),e.jsx(a.Control,{type:"datetime-local",value:r.bookingTime?new Date(r.bookingTime).toISOString().slice(0,16):"",onChange:t=>l({...r,bookingTime:t.target.value}),required:!0})]}),e.jsxs(k,{children:[e.jsx(N,{md:8,children:e.jsxs(a.Group,{className:"mb-3",children:[e.jsx(a.Label,{children:"Select Product *"}),g?e.jsxs("div",{className:"text-center py-2",children:[e.jsx(_,{animation:"border",size:"sm"}),e.jsx("span",{className:"ms-2",children:"Loading products..."})]}):e.jsxs(a.Select,{value:u,onChange:t=>v(t.target.value),required:!0,children:[e.jsx("option",{value:"",children:"-- Select a product --"}),n.map(t=>e.jsxs("option",{value:t.id,children:[t.name," - ",t.price.toLocaleString("vi-VN")," VND"]},t.id))]})]})}),e.jsx(N,{md:4,children:e.jsxs(a.Group,{className:"mb-3",children:[e.jsx(a.Label,{children:"Quantity *"}),e.jsx(a.Control,{type:"number",min:"1",value:b,onChange:t=>y(parseInt(t.target.value)||1),required:!0})]})})]}),B&&e.jsxs($,{variant:"info",className:"mb-3",children:[e.jsx("strong",{children:"Selected:"})," ",B.name," x ",b,e.jsx("br",{}),e.jsx("small",{className:"text-muted",children:B.description}),e.jsx("hr",{className:"my-2"}),e.jsxs("strong",{children:["Total: ",(B.price*b).toLocaleString("vi-VN")," VND"]})]}),e.jsxs("div",{className:"d-flex gap-2 justify-content-end mt-3",children:[m&&o&&e.jsx(j,{type:"button",variant:"secondary",onClick:o,disabled:c,children:f}),e.jsx(j,{type:"submit",variant:"primary",disabled:c||!u||!r.address,children:c?e.jsxs(e.Fragment,{children:[e.jsx(_,{animation:"border",size:"sm",className:"me-2"}),"Submitting..."]}):x})]})]})},ke=({show:i,onHide:n,onSuccess:g})=>{var f;const h=le(),{showNotification:o}=J(),{data:c=[],isLoading:p}=ue(),x=async m=>{try{await h.mutateAsync(m),o("Booking created successfully","success"),n(),g==null||g()}catch(r){o(r instanceof Error?r.message:"Failed to create booking","error")}};return e.jsxs(E,{show:i,onHide:n,size:"lg",children:[e.jsx(E.Header,{closeButton:!0,children:e.jsx(E.Title,{children:"Create New Booking"})}),e.jsx(E.Body,{children:e.jsx(Ce,{products:c,productsLoading:p,onSubmit:x,onCancel:n,isSubmitting:h.isPending,error:h.isError?`Failed to create booking: ${((f=h.error)==null?void 0:f.message)||"Unknown error"}`:null,submitButtonText:"Create Booking",showCancelButton:!0})})]})};const Se=()=>{var U,H;const[i,n]=d.useState(1),[g]=d.useState(10),[h,o]=d.useState("new"),[c,p]=d.useState(""),[x,f]=d.useState(""),[m,r]=d.useState(""),[l,u]=d.useState(""),[v,b]=d.useState(""),[y,S]=d.useState(!1),{data:w=[]}=me();d.useEffect(()=>{const s=setTimeout(()=>{f(c),n(1)},500);return()=>clearTimeout(s)},[c]);const B=s=>s?new Date(s).toISOString():void 0,{data:t,isLoading:T,error:I,refetch:R}=de({page:i,pageSize:g,status:[0,1,2,3,4,5,6,7,8],keyword:x||void 0,bookingFrom:B(m),bookingTo:B(l),technicianId:v||void 0}),{showNotification:P}=J();d.useEffect(()=>{I&&P(I instanceof Error?I.message:"Failed to load bookings","error")},[I,P]);const A={new:(t==null?void 0:t.totalCount)||0,verification:0,approval:0,processed:0},ee=()=>{R(),P("Bookings list refreshed","success")},q=s=>{s.preventDefault(),f(c),n(1)},O=()=>{p(""),f(""),n(1)},se=()=>{r(""),u(""),n(1)},K=()=>{n(1)},te=s=>{b(s),n(1)},re=()=>{b(""),n(1)},ae=(t==null?void 0:t.items)||[];return e.jsxs(e.Fragment,{children:[e.jsx(oe,{title:"Booking Management",subName:"Apps"}),e.jsx(k,{children:e.jsx(N,{xs:12,children:e.jsx(Y,{children:e.jsxs(Y.Body,{children:[e.jsxs(C,{variant:"tabs",className:"nav-bordered mb-4",children:[e.jsx(C.Item,{children:e.jsxs(C.Link,{active:h==="new",onClick:()=>o("new"),className:"d-flex align-items-center gap-2",children:["New",A.new>0&&e.jsx(z,{bg:"danger",className:"ms-1",children:A.new})]})}),e.jsx(C.Item,{children:e.jsxs(C.Link,{active:h==="verification",onClick:()=>o("verification"),className:"d-flex align-items-center gap-2",children:["Verification Due",A.verification>0]})}),e.jsx(C.Item,{children:e.jsxs(C.Link,{active:h==="approval",onClick:()=>o("approval"),className:"d-flex align-items-center gap-2",children:["Approval Due",A.approval>0]})}),e.jsx(C.Item,{children:e.jsxs(C.Link,{active:h==="processed",onClick:()=>o("processed"),className:"d-flex align-items-center gap-2",children:["Processed",A.processed>0]})})]}),e.jsx(k,{className:"mb-4",children:e.jsx(N,{md:12,children:e.jsxs(a,{onSubmit:q,children:[e.jsxs(D,{children:[e.jsx(D.Text,{children:e.jsx("i",{className:"mdi mdi-magnify"})}),e.jsx(a.Control,{type:"text",placeholder:"Search bookings by keyword (customer name, phone, address, code)...",value:c,onChange:s=>p(s.target.value),onKeyDown:s=>{s.key==="Enter"&&(s.preventDefault(),q(s))}}),c&&e.jsx(j,{variant:"outline-secondary",onClick:O,title:"Clear search",children:e.jsx("i",{className:"mdi mdi-close"})}),e.jsx(j,{variant:"primary",type:"submit",children:"Search"})]}),x&&e.jsx("div",{className:"mt-2",children:e.jsxs("small",{className:"text-muted",children:["Searching for: ",e.jsxs("strong",{children:['"',x,'"']})," ",e.jsx(j,{variant:"link",size:"sm",className:"p-0 ms-2",onClick:O,children:"Clear"})]})})]})})}),e.jsxs(k,{className:"mb-4",children:[e.jsx(N,{md:6,children:e.jsxs(a.Group,{children:[e.jsxs(a.Label,{children:[e.jsx("i",{className:"mdi mdi-calendar-start me-1"}),"Booking From"]}),e.jsx(a.Control,{type:"datetime-local",value:m,onChange:s=>{r(s.target.value),K()}})]})}),e.jsx(N,{md:6,children:e.jsxs(a.Group,{children:[e.jsxs(a.Label,{children:[e.jsx("i",{className:"mdi mdi-calendar-end me-1"}),"Booking To"]}),e.jsxs(D,{children:[e.jsx(a.Control,{type:"datetime-local",value:l,onChange:s=>{u(s.target.value),K()}}),(m||l)&&e.jsx(j,{variant:"outline-secondary",onClick:se,title:"Clear date filter",children:e.jsx("i",{className:"mdi mdi-close"})})]})]})})]}),(m||l)&&e.jsx(k,{className:"mb-3",children:e.jsx(N,{md:12,children:e.jsxs("small",{className:"text-muted",children:["Date filter: ",e.jsxs("strong",{children:[m?new Date(m).toLocaleString("vi-VN"):"Any"," â†’ ",l?new Date(l).toLocaleString("vi-VN"):"Any"]})]})})}),e.jsx(k,{className:"mb-4",children:e.jsx(N,{md:6,children:e.jsxs(a.Group,{children:[e.jsxs(a.Label,{children:[e.jsx("i",{className:"mdi mdi-account-wrench me-1"}),"Filter by Technician"]}),e.jsxs(D,{children:[e.jsxs(a.Select,{value:v,onChange:s=>te(s.target.value),children:[e.jsx("option",{value:"",children:"All Technicians"}),w.map(s=>e.jsxs("option",{value:s.id,children:[s.name," ",s.phone?`(${s.phone})`:""]},s.id))]}),v&&e.jsx(j,{variant:"outline-secondary",onClick:re,title:"Clear technician filter",children:e.jsx("i",{className:"mdi mdi-close"})})]}),v&&e.jsxs(a.Text,{className:"text-muted",children:["Showing bookings for: ",e.jsx("strong",{children:((U=w.find(s=>s.id===v))==null?void 0:U.name)||"Selected Technician"})]})]})})}),e.jsx(k,{className:"mb-4",children:e.jsx(N,{xs:12,children:e.jsxs(ve,{className:"mb-2 gap-1",children:[e.jsxs(j,{variant:"primary",size:"sm",onClick:()=>S(!0),children:[e.jsx("i",{className:"mdi mdi-plus me-1"}),"Create Booking"]}),e.jsxs(j,{variant:"secondary",size:"sm",onClick:async()=>{try{await R(),P("Bookings list refreshed","success")}catch(s){P(s instanceof Error?s.message:"Failed to refresh bookings","error")}},children:[e.jsx("i",{className:"mdi mdi-refresh me-1"}),"Reload"]})]})})}),I&&e.jsxs($,{variant:"danger",children:[e.jsx("strong",{children:"Error:"})," ",I instanceof Error?I.message:"Failed to load bookings"]}),T?e.jsxs("div",{className:"text-center py-5",children:[e.jsx(_,{animation:"border",variant:"primary"}),e.jsx("p",{className:"mt-2",children:"Loading bookings..."})]}):t!=null&&t.items&&t.items.length>0?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-centered table-striped table-hover",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Booking Code"}),e.jsx("th",{children:"Customer Name"}),e.jsx("th",{children:"Phone"}),e.jsx("th",{children:"Address"}),e.jsx("th",{children:"Booking Time"}),e.jsx("th",{children:"Items"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Created At"}),e.jsx("th",{className:"booking-actions-column",children:"Actions"})]})}),e.jsx("tbody",{children:ae.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("code",{className:"text-primary",children:s.code||s.id.substring(0,8)})}),e.jsx("td",{children:e.jsx("strong",{children:s.customerName||"N/A"})}),e.jsx("td",{children:s.customerPhone||"-"}),e.jsx("td",{className:"text-muted",children:e.jsx("small",{children:s.address||"-"})}),e.jsx("td",{children:new Date(s.bookingTime).toLocaleString("vi-VN")}),e.jsx("td",{children:s.items&&s.items.length>0?e.jsxs(z,{bg:"info",children:[s.items.length," items"]}):s.totalPrice?e.jsxs(z,{bg:"secondary",children:[s.totalPrice.toLocaleString("vi-VN")," VND"]}):e.jsx("span",{className:"text-muted",children:"-"})}),e.jsx("td",{children:he(s.status)}),e.jsx("td",{children:s.createdAt?new Date(s.createdAt).toLocaleString("vi-VN"):"-"}),e.jsx("td",{className:"booking-actions-column",children:e.jsx(ce,{to:`/apps/booking/${s.id}`,children:e.jsxs(j,{variant:"outline-primary",size:"sm",onClick:Q=>Q.stopPropagation(),children:[e.jsx("i",{className:"mdi mdi-eye me-1"}),"View"]})})})]},s.id))})]})}),e.jsx(k,{className:"mt-4",children:e.jsx(N,{xs:12,children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{className:"text-muted",children:["Showing ",((H=t.items)==null?void 0:H.length)||0," of ",t.totalCount," bookings"]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx(j,{variant:"secondary",size:"sm",disabled:i===1,onClick:()=>n(i-1),children:"Previous"}),e.jsxs(j,{variant:"secondary",size:"sm",disabled:!0,children:["Page ",i," of ",t.totalPages]}),e.jsx(j,{variant:"secondary",size:"sm",disabled:i>=t.totalPages,onClick:()=>n(i+1),children:"Next"})]})]})})})]}):e.jsxs("div",{className:"text-center py-5",children:[e.jsx("p",{className:"text-muted",children:"No bookings found"}),e.jsx(j,{variant:"primary",onClick:()=>S(!0),children:"Create First Booking"})]})]})})})}),e.jsx(ke,{show:y,onHide:()=>S(!1),onSuccess:ee})]})},Ze=()=>e.jsx(Se,{});export{Ze as default};
