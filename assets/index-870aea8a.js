import{w as K,aZ as H,q as L,j as e,r as u,aW as f,P as Q,d as F,f as b,h as z,v as R,bn as J}from"./index-049ade0a.js";import{u as V}from"./useQuery-4147274f.js";import{u as $}from"./useMutation-56f107bc.js";import{B as _}from"./ButtonGroup-58250639.js";import{B as v}from"./Button-08ebfda8.js";import{S as T}from"./Spinner-bee679bc.js";import{A as B}from"./Alert-7f154918.js";import{M as A}from"./Modal-2f10061d.js";const G="https://api.dev.usta.vn",y=K.create({baseURL:`${G}/api`,timeout:3e4,headers:{"Content-Type":"application/json"}});y.interceptors.request.use(async s=>{const t=localStorage.getItem("_USTA_OAUTH");if(t)try{const n=JSON.parse(t);s.headers.Authorization=`Bearer ${n.accessToken}`,console.log("[Technician API] Request:",{method:s.method,url:s.url,params:s.params,hasAuth:!!s.headers.Authorization})}catch(n){console.error("[Technician API] Failed to parse OAuth session:",n)}else console.warn("[Technician API] No OAuth session found");return s},s=>(console.error("[Technician API] Request error:",s),Promise.reject(s)));y.interceptors.response.use(s=>(console.log("[Technician API] Response:",{status:s.status,url:s.config.url,data:s.data}),s),s=>{var t,n,r;return console.error("[Technician API] Response error:",{status:(t=s.response)==null?void 0:t.status,url:(n=s.config)==null?void 0:n.url,data:(r=s.response)==null?void 0:r.data,message:s.message}),Promise.reject(s)});async function Z(s={}){console.log("[Technician API] Fetching technicians:",s);const t=await y.get("/technicians/",{params:s});if(t.data.success)return t.data.data;throw new Error(t.data.error||"Failed to fetch technicians")}async function W(s){console.log("[Technician API] Fetching technician by ID:",s);const t=await y.get(`/technicians/${s}`);if(t.data&&typeof t.data=="object"&&"success"in t.data){const n=t.data;if(n.success&&n.data)return n.data;throw new Error(n.error||"Failed to fetch technician")}return t.data}async function X(s){var t,n,r,p;console.log("[Technician API] Approving technician:",s);try{const{technicianId:c,...m}=s,l=await y.post(`/technicians/${c}/approve`,m);if(l.data.success&&l.data.data)return l.data.data;throw new Error(l.data.error||l.data.message||"Failed to approve technician")}catch(c){console.error("[Technician API] Error approving technician:",c);const m=((n=(t=c.response)==null?void 0:t.data)==null?void 0:n.error)||((p=(r=c.response)==null?void 0:r.data)==null?void 0:p.message)||c.message||"Failed to approve technician";throw new Error(m)}}async function Y(s){var t,n,r,p;console.log("[Technician API] Rejecting technician:",s);try{const{technicianId:c,reason:m}=s,l=await y.post(`/technicians/${c}/reject`,{reason:m});if(!l.data.success)throw new Error(l.data.error||l.data.message||"Failed to reject technician")}catch(c){console.error("[Technician API] Error rejecting technician:",c);const m=((n=(t=c.response)==null?void 0:t.data)==null?void 0:n.error)||((p=(r=c.response)==null?void 0:r.data)==null?void 0:p.message)||c.message||"Failed to reject technician";throw new Error(m)}}function ee(s={}){return V({queryKey:["technicians",s],queryFn:()=>Z(s),staleTime:3e4,retry:2,select:t=>t||[]})}function se(s){return V({queryKey:["technician",s],queryFn:()=>W(s),enabled:!!s,staleTime:3e4})}function ae(){const s=H(),{showNotification:t}=L();return $({mutationFn:n=>X(n),onSuccess:()=>{s.invalidateQueries({queryKey:["technicians"]}),t({message:"Technician approved successfully",type:"success"})},onError:n=>{const r=(n==null?void 0:n.message)||"Failed to approve technician";t({message:r,type:"error"})}})}function ne(){const s=H(),{showNotification:t}=L();return $({mutationFn:n=>Y(n),onSuccess:()=>{s.invalidateQueries({queryKey:["technicians"]}),t({message:"Technician rejected successfully",type:"success"})},onError:n=>{const r=(n==null?void 0:n.message)||"Failed to reject technician";t({message:r,type:"error"})}})}const te=({onApprove:s,onReject:t,onViewDetail:n,processingId:r,isApproving:p,isRejecting:c,needsApproval:m,getStatusBadge:l,getRatingStars:N})=>[{Header:"Name",accessor:"name",defaultCanSort:!0,Cell:({row:d})=>{const o=d.original;return e.jsxs("div",{children:[e.jsx("strong",{children:o.name}),o.address&&e.jsx("div",{className:"text-muted small",children:o.address})]})}},{Header:"Phone",accessor:"phone",defaultCanSort:!0},{Header:"Email",accessor:"email",defaultCanSort:!0,Cell:({value:d})=>d||e.jsx("span",{className:"text-muted",children:"-"})},{Header:"Specialization",accessor:"specialization",defaultCanSort:!1,Cell:({value:d})=>d||e.jsx("span",{className:"text-muted",children:"-"})},{Header:"Rating",accessor:"rating",defaultCanSort:!0,Cell:({row:d})=>{const o=d.original;return N(o.rating)}},{Header:"Status",accessor:"status",defaultCanSort:!0,Cell:({row:d})=>{const o=d.original;return l(o.status)}},{Header:"Created At",accessor:"createdAt",defaultCanSort:!0,Cell:({value:d})=>new Date(d).toLocaleDateString("vi-VN")},{Header:"Actions",accessor:"id",defaultCanSort:!1,Cell:({row:d})=>{const o=d.original,x=r===o.id,i=m(o);return e.jsx("div",{className:"d-flex gap-1",children:e.jsxs(_,{size:"sm",className:"gap-1",children:[e.jsx(v,{variant:"info",onClick:g=>{g.stopPropagation(),n(o)},title:"View Details",children:e.jsx("i",{className:"mdi mdi-eye"})}),i&&e.jsxs(e.Fragment,{children:[e.jsx(v,{variant:"success",onClick:g=>{g.stopPropagation(),s(o)},disabled:x,title:"Approve",children:x&&p?e.jsxs(e.Fragment,{children:[e.jsx(T,{animation:"border",size:"sm",className:"me-1"}),"Approving..."]}):"Approve"}),e.jsx(v,{variant:"danger",onClick:g=>{g.stopPropagation(),t(o)},disabled:x,title:"Reject",children:x&&c?e.jsxs(e.Fragment,{children:[e.jsx(T,{animation:"border",size:"sm",className:"me-1"}),"Rejecting..."]}):"Reject"})]})]})})}}],ie=[{text:"10",value:10},{text:"25",value:25},{text:"50",value:50},{text:"100",value:100}],re=()=>{const[s,t]=u.useState(void 0),[n,r]=u.useState(null),[p,c]=u.useState(null),[m,l]=u.useState(!1),{data:N=[],isLoading:d,error:o,refetch:x}=ee(s!==void 0?{status:s}:{}),{data:i,isLoading:g,error:k}=se(p||""),C=ae(),w=ne(),P=u.useCallback(a=>{switch(a){case 1:return e.jsx(f,{bg:"info",children:"Pending"});case 2:return e.jsx(f,{bg:"success",children:"Approved"});case 3:return e.jsx(f,{bg:"danger",children:"Rejected"});default:return e.jsx(f,{bg:"secondary",children:"Unknown"})}},[]),S=u.useCallback(a=>a.status===1,[]),E=u.useCallback(async a=>{if(!S(a))return;const h=a.name||a.phone||a.id||"this technician";if(window.confirm(`Are you sure you want to approve ${h}?`)){r(a.id);try{await C.mutateAsync({technicianId:a.id,profileId:a.profileId,skills:a.skills,zones:a.zones})}catch(j){console.error("Failed to approve technician:",j)}finally{r(null)}}},[S,C]),D=u.useCallback(async a=>{const h=a.name||a.phone||a.id||"this technician",j=window.prompt(`Enter reason for rejecting ${h} (optional):`);if(j!==null&&window.confirm(`Are you sure you want to reject ${h}?`)){r(a.id);try{await w.mutateAsync({technicianId:a.id,reason:j||void 0})}catch(U){console.error("Failed to reject technician:",U)}finally{r(null)}}},[w]),I=u.useCallback(a=>{if(!a)return e.jsx("span",{className:"text-muted",children:"No rating"});const h="â­".repeat(Math.round(a));return e.jsxs("span",{children:[h," (",a.toFixed(1),")"]})},[]),M=u.useCallback(a=>{c(a.id),l(!0)},[]),q=u.useCallback(()=>{l(!1),c(null)},[]),O=u.useMemo(()=>te({onApprove:E,onReject:D,onViewDetail:M,processingId:n,isApproving:C.isPending,isRejecting:w.isPending,needsApproval:S,getStatusBadge:P,getRatingStars:I}),[E,D,M,n,C.isPending,w.isPending,S,P,I]);return e.jsxs(e.Fragment,{children:[e.jsx(Q,{title:"Technician Management",subName:"Apps"}),e.jsx(F,{children:e.jsx(b,{xs:12,children:e.jsx(z,{children:e.jsxs(z.Body,{children:[e.jsx(F,{className:"mb-3",children:e.jsx(b,{md:4,children:e.jsxs(R.Group,{children:[e.jsx(R.Label,{children:"Filter by Status"}),e.jsxs(R.Select,{value:s??"",onChange:a=>{const h=a.target.value;t(h===""?void 0:Number(h))},children:[e.jsx("option",{value:"",children:"All"}),e.jsx("option",{value:1,children:"Pending"}),e.jsx("option",{value:2,children:"Approved"}),e.jsx("option",{value:3,children:"Rejected"})]})]})})}),o&&e.jsxs(B,{variant:"danger",dismissible:!0,children:["Failed to load technicians: ",o.message,e.jsx(v,{variant:"link",onClick:()=>x(),children:"Try Again"})]}),d?e.jsxs("div",{className:"text-center py-5",children:[e.jsx(T,{animation:"border",variant:"primary"}),e.jsx("p",{className:"mt-2",children:"Loading technicians..."})]}):N&&N.length>0?e.jsx(J,{columns:O,data:N,pageSize:10,sizePerPageList:ie,isSortable:!0,pagination:!0,isSearchable:!0,theadClass:"table-light"}):e.jsxs("div",{className:"text-center py-5",children:[e.jsx("p",{className:"text-muted",children:"No technicians found"}),e.jsx(v,{variant:"link",onClick:()=>x(),children:"Try Again"})]})]})})})}),e.jsxs(A,{show:m,onHide:q,size:"lg",children:[e.jsx(A.Header,{closeButton:!0,children:e.jsx(A.Title,{children:"Technician Details"})}),e.jsx(A.Body,{children:g?e.jsxs("div",{className:"text-center py-5",children:[e.jsx(T,{animation:"border",variant:"primary"}),e.jsx("p",{className:"mt-2",children:"Loading technician details..."})]}):k?e.jsxs(B,{variant:"danger",children:["Failed to load technician details: ",k.message,e.jsx("div",{className:"mt-2",children:e.jsx(v,{variant:"link",size:"sm",onClick:()=>l(!1),children:"Close"})})]}):i?e.jsxs(F,{children:[e.jsxs(b,{md:6,children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Name:"}),e.jsx("p",{className:"mb-0",children:i.name})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Phone:"}),e.jsx("p",{className:"mb-0",children:i.phone})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Email:"}),e.jsx("p",{className:"mb-0",children:i.email||e.jsx("span",{className:"text-muted",children:"-"})})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Address:"}),e.jsx("p",{className:"mb-0",children:i.address||e.jsx("span",{className:"text-muted",children:"-"})})]})]}),e.jsxs(b,{md:6,children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Status:"}),e.jsx("p",{className:"mb-0",children:P(i.status)})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Specialization:"}),e.jsx("p",{className:"mb-0",children:i.specialization||e.jsx("span",{className:"text-muted",children:"-"})})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Rating:"}),e.jsx("p",{className:"mb-0",children:I(i.rating)})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Created At:"}),e.jsx("p",{className:"mb-0",children:new Date(i.createdAt).toLocaleDateString("vi-VN",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})})]}),i.updatedAt&&e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Updated At:"}),e.jsx("p",{className:"mb-0",children:new Date(i.updatedAt).toLocaleDateString("vi-VN",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})})]})]}),i.profileId&&e.jsxs(b,{xs:12,children:[e.jsx("hr",{}),e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Profile ID:"}),e.jsx("p",{className:"mb-0 text-muted small",children:i.profileId})]}),i.skills&&i.skills.length>0&&e.jsxs("div",{className:"mb-2",children:[e.jsxs("strong",{children:["Skills (",i.skills.length,"):"]}),e.jsx("div",{className:"mt-1",children:i.skills.map((a,h)=>{const j=typeof a=="string"?a:(a==null?void 0:a.name)||JSON.stringify(a);return e.jsx(f,{bg:"primary",className:"me-1",children:j},h)})})]}),i.zones&&i.zones.length>0&&e.jsxs("div",{className:"mb-2",children:[e.jsxs("strong",{children:["Zones (",i.zones.length,"):"]}),e.jsx("div",{className:"mt-1",children:i.zones.map((a,h)=>{const j=typeof a=="string"?a:(a==null?void 0:a.name)||JSON.stringify(a);return e.jsx(f,{bg:"info",className:"me-1",children:j},h)})})]})]})]}):null}),e.jsx(A.Footer,{children:e.jsx(v,{variant:"secondary",onClick:q,children:"Close"})})]})]})},je=()=>e.jsx(re,{});export{je as default};
