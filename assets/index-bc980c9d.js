import{w as L,aZ as q,r as x,j as e,P as F,d as g,f as m,h as f,aV as c,aW as N,v as r}from"./index-d6599812.js";import{u as E,a as D}from"./useMutation-f736d124.js";import{B as R}from"./ButtonGroup-d58ff8e1.js";import{B as u}from"./Button-0d211eca.js";import{A as z}from"./Alert-424c39a4.js";import{S as G}from"./Spinner-c003c098.js";import{M as b}from"./Modal-a1fa8454.js";const M={}.VITE_API_SERVER||"http://localhost:80",k=L.create({baseURL:`${M}/api`,timeout:3e4,headers:{"Content-Type":"application/json"}});k.interceptors.request.use(async s=>{const a=localStorage.getItem("_USTA_OAUTH");if(a)try{const i=JSON.parse(a);s.headers.Authorization=`Bearer ${i.accessToken}`,console.log("[Booking API] Request:",{method:s.method,url:s.url,params:s.params,data:s.data,hasAuth:!!s.headers.Authorization})}catch(i){console.error("[Booking API] Failed to parse OAuth session:",i)}else console.warn("[Booking API] No OAuth session found");return s},s=>(console.error("[Booking API] Request error:",s),Promise.reject(s)));k.interceptors.response.use(s=>(console.log("[Booking API] Response:",{status:s.status,url:s.config.url,data:s.data}),s),s=>{var a,i,d;return console.error("[Booking API] Response error:",{status:(a=s.response)==null?void 0:a.status,url:(i=s.config)==null?void 0:i.url,data:(d=s.response)==null?void 0:d.data,message:s.message}),Promise.reject(s)});async function O(s={}){const{page:a=1,pageSize:i=10}=s;return console.log("[Booking API] Fetching bookings:",{page:a,pageSize:i}),(await k.get("/bookings",{params:{page:a,pageSize:i}})).data}async function J(s){console.log("[Booking API] Creating booking:",s);const a=await k.post("/bookings/",s);return console.log("[Booking API] Booking created successfully:",a.data),a.data}function V(s={}){return E({queryKey:["bookings",s],queryFn:()=>O(s),staleTime:3e4,retry:2})}function _(){const s=q();return D({mutationFn:a=>J(a),onSuccess:a=>{console.log("[useCreateBooking] Booking created successfully:",a),s.invalidateQueries({queryKey:["bookings"]})},onError:a=>{console.error("[useCreateBooking] Failed to create booking:",a)}})}const H=()=>{const[s,a]=x.useState(1),[i]=x.useState(10),[d,v]=x.useState("new"),[B,S]=x.useState(""),[P,j]=x.useState(!1),[n,l]=x.useState({bookingTime:"",customerId:"",customerName:"",customerPhone:"",latitude:0,longitude:0,address:"",items:[]}),{data:o,isLoading:A,error:y,refetch:I}=V({page:s,pageSize:i}),C=_(),p={new:(o==null?void 0:o.total)||0,verification:0,approval:0,processed:0},w=async t=>{t.preventDefault();try{const h={...n,bookingTime:new Date(n.bookingTime).toISOString()};await C.mutateAsync(h),j(!1),l({bookingTime:"",customerId:"",customerName:"",customerPhone:"",latitude:0,longitude:0,address:"",items:[]})}catch(h){console.error("Failed to create booking:",h)}},T=(o==null?void 0:o.items)||[];return e.jsxs(e.Fragment,{children:[e.jsx(F,{title:"Booking Management",subName:"Apps"}),e.jsx(g,{children:e.jsx(m,{xs:12,children:e.jsx(f,{children:e.jsxs(f.Body,{children:[e.jsxs(c,{variant:"tabs",className:"nav-bordered mb-4",children:[e.jsx(c.Item,{children:e.jsxs(c.Link,{active:d==="new",onClick:()=>v("new"),className:"d-flex align-items-center gap-2",children:["New",p.new>0&&e.jsx(N,{bg:"danger",className:"ms-1",children:p.new})]})}),e.jsx(c.Item,{children:e.jsxs(c.Link,{active:d==="verification",onClick:()=>v("verification"),className:"d-flex align-items-center gap-2",children:["Verification Due",p.verification>0]})}),e.jsx(c.Item,{children:e.jsxs(c.Link,{active:d==="approval",onClick:()=>v("approval"),className:"d-flex align-items-center gap-2",children:["Approval Due",p.approval>0]})}),e.jsx(c.Item,{children:e.jsxs(c.Link,{active:d==="processed",onClick:()=>v("processed"),className:"d-flex align-items-center gap-2",children:["Processed",p.processed>0]})})]}),e.jsx(g,{className:"mb-4",children:e.jsx(m,{md:12,children:e.jsxs("div",{className:"position-relative",children:[e.jsx("i",{className:"mdi mdi-magnify position-absolute top-50 start-0 translate-middle-y ms-3 text-muted",style:{fontSize:"18px"}}),e.jsx(r.Control,{type:"text",placeholder:"Search bookings by customer name...",value:B,onChange:t=>S(t.target.value),className:"ps-5"})]})})}),e.jsx(g,{className:"mb-4",children:e.jsx(m,{xs:12,children:e.jsxs(R,{className:"mb-2",children:[e.jsxs(u,{variant:"primary",size:"sm",onClick:()=>j(!0),children:[e.jsx("i",{className:"mdi mdi-plus me-1"}),"Create Booking"]}),e.jsxs(u,{variant:"secondary",size:"sm",onClick:()=>I(),children:[e.jsx("i",{className:"mdi mdi-refresh me-1"}),"Reload"]})]})})}),y&&e.jsxs(z,{variant:"danger",children:[e.jsx("strong",{children:"Error:"})," ",y instanceof Error?y.message:"Failed to load bookings"]}),A?e.jsxs("div",{className:"text-center py-5",children:[e.jsx(G,{animation:"border",variant:"primary"}),e.jsx("p",{className:"mt-2",children:"Loading bookings..."})]}):o!=null&&o.items&&o.items.length>0?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-centered table-striped table-hover",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Customer Name"}),e.jsx("th",{children:"Phone"}),e.jsx("th",{children:"Address"}),e.jsx("th",{children:"Booking Time"}),e.jsx("th",{children:"Items"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Created At"})]})}),e.jsx("tbody",{children:T.map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:t.customerName})}),e.jsx("td",{children:t.customerPhone}),e.jsx("td",{className:"text-muted",children:e.jsx("small",{children:t.address})}),e.jsx("td",{children:new Date(t.bookingTime).toLocaleString()}),e.jsx("td",{children:e.jsxs(N,{bg:"info",children:[t.items.length," items"]})}),e.jsx("td",{children:e.jsx(N,{bg:t.status==="pending"?"warning":"success",children:t.status})}),e.jsx("td",{children:new Date(t.createdAt).toLocaleDateString()})]},t.id))})]})}),e.jsx(g,{className:"mt-4",children:e.jsx(m,{xs:12,children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{className:"text-muted",children:["Showing ",o.items.length," of ",o.total," bookings"]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx(u,{variant:"secondary",size:"sm",disabled:s===1,onClick:()=>a(s-1),children:"Previous"}),e.jsxs(u,{variant:"secondary",size:"sm",disabled:!0,children:["Page ",s," of ",o.totalPages]}),e.jsx(u,{variant:"secondary",size:"sm",disabled:s>=o.totalPages,onClick:()=>a(s+1),children:"Next"})]})]})})})]}):e.jsxs("div",{className:"text-center py-5",children:[e.jsx("p",{className:"text-muted",children:"No bookings found"}),e.jsx(u,{variant:"primary",onClick:()=>j(!0),children:"Create First Booking"})]})]})})})}),e.jsxs(b,{show:P,onHide:()=>j(!1),size:"lg",children:[e.jsx(b.Header,{closeButton:!0,children:e.jsx(b.Title,{children:"Create New Booking"})}),e.jsxs(r,{onSubmit:w,children:[e.jsxs(b.Body,{children:[e.jsxs(g,{children:[e.jsx(m,{md:6,children:e.jsxs(r.Group,{className:"mb-3",children:[e.jsx(r.Label,{children:"Customer Name *"}),e.jsx(r.Control,{type:"text",placeholder:"Enter customer name",value:n.customerName,onChange:t=>l({...n,customerName:t.target.value}),required:!0})]})}),e.jsx(m,{md:6,children:e.jsxs(r.Group,{className:"mb-3",children:[e.jsx(r.Label,{children:"Customer Phone *"}),e.jsx(r.Control,{type:"tel",placeholder:"0352978519",value:n.customerPhone,onChange:t=>l({...n,customerPhone:t.target.value}),required:!0})]})})]}),e.jsxs(r.Group,{className:"mb-3",children:[e.jsx(r.Label,{children:"Customer ID *"}),e.jsx(r.Control,{type:"text",placeholder:"Enter customer ID",value:n.customerId,onChange:t=>l({...n,customerId:t.target.value}),required:!0})]}),e.jsxs(r.Group,{className:"mb-3",children:[e.jsx(r.Label,{children:"Address *"}),e.jsx(r.Control,{type:"text",placeholder:"123 Nguyễn Thị Minh Khai, Q.1, TP.HCM",value:n.address,onChange:t=>l({...n,address:t.target.value}),required:!0})]}),e.jsxs(g,{children:[e.jsx(m,{md:6,children:e.jsxs(r.Group,{className:"mb-3",children:[e.jsx(r.Label,{children:"Latitude *"}),e.jsx(r.Control,{type:"number",step:"any",placeholder:"10.762622",value:n.latitude,onChange:t=>l({...n,latitude:parseFloat(t.target.value)}),required:!0})]})}),e.jsx(m,{md:6,children:e.jsxs(r.Group,{className:"mb-3",children:[e.jsx(r.Label,{children:"Longitude *"}),e.jsx(r.Control,{type:"number",step:"any",placeholder:"106.660172",value:n.longitude,onChange:t=>l({...n,longitude:parseFloat(t.target.value)}),required:!0})]})})]}),e.jsxs(r.Group,{className:"mb-3",children:[e.jsx(r.Label,{children:"Booking Time *"}),e.jsx(r.Control,{type:"datetime-local",value:n.bookingTime,onChange:t=>l({...n,bookingTime:t.target.value}),required:!0})]}),e.jsxs(r.Group,{className:"mb-3",children:[e.jsx(r.Label,{children:"Items (JSON format) *"}),e.jsx(r.Control,{as:"textarea",rows:3,placeholder:'[{"productId": "0199f1bf-f061-79b9-8d2f-d504d58757c6", "quantity": 2}]',value:JSON.stringify(n.items),onChange:t=>{try{const h=JSON.parse(t.target.value);l({...n,items:h})}catch{}},required:!0}),e.jsx(r.Text,{className:"text-muted",children:"Enter items in JSON format with productId and quantity"})]})]}),e.jsxs(b.Footer,{children:[e.jsx(u,{variant:"secondary",onClick:()=>j(!1),children:"Cancel"}),e.jsx(u,{variant:"primary",type:"submit",disabled:C.isPending,children:C.isPending?"Creating...":"Create Booking"})]})]})]})]})},Y=()=>e.jsx(H,{});export{Y as default};
