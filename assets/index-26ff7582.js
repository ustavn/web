import{r as c,z,j as e,l as $,Q as se,S as te,o as ae,U as re,a as oe,P as ne,d as S,f as y,h as O,_ as ie,R as le,c as V}from"./index-1c09459b.js";import{F as i}from"./Form-9237be30.js";import{u as U}from"./useQuery-00218134.js";import{u as ce}from"./useMutation-cc409948.js";import{u as de}from"./useProducts-ffefb872.js";import{u as ue}from"./hook-95b25f1d.js";import{u as me,B as ge}from"./Nav-2f954c07.js";import{N as he}from"./NavbarContext-25385990.js";import{m as pe}from"./NavContext-6ce83af4.js";import{B as x}from"./Badge-8e317aab.js";import{B as xe}from"./ButtonGroup-17e0a310.js";import{B as b}from"./Button-f56a0820.js";import{A as _}from"./Alert-582bd80a.js";import{S as E}from"./Spinner-ed2097a1.js";import{M as A}from"./Modal-1b87b88a.js";const K=c.forwardRef(({className:s,bsPrefix:a,as:r="div",...l},n)=>(a=z(a,"nav-item"),e.jsx(r,{ref:n,className:$(s,a),...l})));K.displayName="NavItem";const je=K,Q=c.forwardRef(({bsPrefix:s,className:a,as:r=se,active:l,eventKey:n,disabled:d=!1,...j},p)=>{s=z(s,"nav-link");const[C,h]=me({key:pe(n,j.href),active:l,disabled:d,...j});return e.jsx(r,{...j,...C,ref:p,disabled:d,className:$(a,s,d&&"disabled",h.isActive&&"active")})});Q.displayName="NavLink";const fe=Q,H=c.forwardRef((s,a)=>{const{as:r="div",bsPrefix:l,variant:n,fill:d=!1,justify:j=!1,navbar:p,navbarScroll:C,className:h,activeKey:o,...u}=ue(s,{activeKey:"onSelect"}),m=z(l,"nav");let B,v,N=!1;const g=c.useContext(he),T=c.useContext(te);return g?(B=g.bsPrefix,N=p??!0):T&&({cardHeaderBsPrefix:v}=T),e.jsx(ge,{as:r,ref:a,activeKey:o,className:$(h,{[m]:!N,[`${B}-nav`]:N,[`${B}-nav-scroll`]:N&&C,[`${v}-${n}`]:!!v,[`${m}-${n}`]:!!n,[`${m}-fill`]:d,[`${m}-justified`]:j}),...u})});H.displayName="Nav";const f=Object.assign(H,{Item:je,Link:fe});let D=!1,I=!1;const L=[],ve=({onPlaceSelected:s,value:a="",placeholder:r="Search for an address",required:l=!1})=>{const n=c.useRef(null),d=c.useRef(null);return c.useEffect(()=>{n.current&&a&&(n.current.value=a)},[a]),c.useEffect(()=>{const j="AIzaSyB5490SkKLDlee3fYtZj6dMOXZdy_NNZ3k",p=()=>{if(!n.current){setTimeout(p,100);return}if(!window.google||!window.google.maps||!window.google.maps.places){setTimeout(p,200);return}try{d.current&&google.maps.event.clearInstanceListeners(d.current);const h={types:["geocode","establishment"],componentRestrictions:{country:"vn"},fields:["formatted_address","geometry","name"]};d.current=new google.maps.places.Autocomplete(n.current,h),setTimeout(()=>{document.querySelector(".pac-container")},1e3),d.current.addListener("place_changed",()=>{var m;const o=(m=d.current)==null?void 0:m.getPlace();if(!o||!o.geometry||!o.geometry.location)return;const u={address:o.formatted_address||"",latitude:o.geometry.location.lat(),longitude:o.geometry.location.lng()};n.current&&(n.current.value=u.address),s(u)})}catch{}};return(()=>{if(D||window.google&&window.google.maps&&window.google.maps.places){D=!0,p();return}if(I){L.push(p);return}const h=document.querySelector('script[src*="maps.googleapis.com"]');if(h){I=!0,h.addEventListener("load",()=>{D=!0,I=!1,p(),L.forEach(m=>m()),L.length=0});return}const o=`https://maps.googleapis.com/maps/api/js?key=${j}&libraries=places`;I=!0;const u=document.createElement("script");u.src=o,u.async=!0,u.defer=!0,u.onload=()=>{D=!0,I=!1,p(),L.forEach(m=>m()),L.length=0},u.onerror=()=>{I=!1},document.head.appendChild(u)})(),()=>{if(d.current&&window.google&&window.google.maps)try{google.maps.event.clearInstanceListeners(d.current)}catch{}}},[s]),e.jsxs(e.Fragment,{children:[e.jsx("style",{children:`
				.pac-container {
					z-index: 9999 !important;
					position: fixed !important;
				}
			`}),e.jsx("div",{style:{position:"relative"},children:e.jsx(i.Control,{ref:n,type:"text",defaultValue:a,placeholder:r,required:l,autoComplete:"off",id:"google-places-autocomplete-input"})})]})},Z="https://api.dev.usta.vn",R=ae.create({baseURL:`${Z}/api`,timeout:3e4,headers:{"Content-Type":"application/json"}});R.interceptors.request.use(async s=>{const a=localStorage.getItem("_USTA_OAUTH");if(a)try{const r=JSON.parse(a);s.headers.Authorization=`Bearer ${r.accessToken}`,console.log("[Booking API] Request:",{method:s.method,url:s.url,params:s.params,data:s.data,hasAuth:!!s.headers.Authorization})}catch(r){console.error("[Booking API] Failed to parse OAuth session:",r)}else console.warn("[Booking API] No OAuth session found");return s},s=>(console.error("[Booking API] Request error:",s),Promise.reject(s)));R.interceptors.response.use(s=>(console.log("[Booking API] Response:",{status:s.status,url:s.config.url,data:s.data}),s),s=>{var a,r,l;return console.error("[Booking API] Response error:",{status:(a=s.response)==null?void 0:a.status,url:(r=s.config)==null?void 0:r.url,data:(l=s.response)==null?void 0:l.data,message:s.message}),Promise.reject(s)});async function ye(s={}){const{page:a=1,pageSize:r=10}=s;console.log("[Booking API] Fetching bookings:",{page:a,pageSize:r});const l=await R.get("/bookings",{params:{page:a,pageSize:r}});return l.data.success&&l.data.data?{items:l.data.data.items||[],total:l.data.data.totalCount||0,page:l.data.data.page||a,pageSize:l.data.data.pageSize||r,totalPages:l.data.data.totalPages||1}:l.data}async function be(s){console.log("[Booking API] Creating booking:",s);const a=await R.post("/bookings/",s);return console.log("[Booking API] Booking created successfully:",a.data),a.data}async function Ne(s){var a;console.log("[Booking API] Fetching booking by ID:",s),console.log("[Booking API] Full URL will be:",`${Z}/api/bookings/${s}`);try{const r=await R.get(`/bookings/${s}`);if(console.log("[Booking API] Raw response:",r.data),r.data&&typeof r.data=="object"&&"success"in r.data){const n=r.data;if(n.success&&n.data)return console.log("[Booking API] Returning wrapped data:",n.data),n.data}return console.log("[Booking API] Treating as direct response"),r.data}catch(r){throw console.error("[Booking API] Error fetching booking:",r),console.error("[Booking API] Error response:",(a=r.response)==null?void 0:a.data),r}}function ke(s={}){return U({queryKey:["bookings",s],queryFn:()=>ye(s),staleTime:3e4,retry:2})}function Ve(s){console.log("[useBooking] Hook called with id:",s);const a=U({queryKey:["booking",s],queryFn:()=>(console.log("[useBooking] Query function called, fetching booking:",s),Ne(s)),enabled:!!s&&s.length>0,staleTime:3e4,retry:2});return console.log("[useBooking] Query state:",{isLoading:a.isLoading,isFetching:a.isFetching,isError:a.isError,enabled:!!s&&s.length>0,data:a.data}),a}function Ce(){const s=re();return ce({mutationFn:a=>be(a),onSuccess:a=>{console.log("[useCreateBooking] Booking created successfully:",a),s.invalidateQueries({queryKey:["bookings"]})},onError:a=>{console.error("[useCreateBooking] Failed to create booking:",a)}})}const Be=()=>{var G;const s=oe(),[a,r]=c.useState(1),[l]=c.useState(10),[n,d]=c.useState("new"),[j,p]=c.useState(""),[C,h]=c.useState(!1),[o,u]=c.useState({bookingTime:"",customerId:"",customerName:"",customerPhone:"",latitude:0,longitude:0,address:"",items:[]}),[m,B]=c.useState(""),[v,N]=c.useState(1),{data:g,isLoading:T,error:q,refetch:Y}=ke({page:a,pageSize:l}),P=Ce(),{data:M=[],isLoading:J}=de(),w={new:(g==null?void 0:g.total)||0,verification:0,approval:0,processed:0},X=async t=>{if(t.preventDefault(),!m){alert("Please select a product");return}try{const k={...o,bookingTime:new Date(o.bookingTime).toISOString(),items:[{productId:m,quantity:v}]};await P.mutateAsync(k),h(!1),u({bookingTime:"",customerId:"",customerName:"",customerPhone:"",latitude:0,longitude:0,address:"",items:[]}),B(""),N(1)}catch(k){console.error("Failed to create booking:",k)}},W=t=>{u(k=>({...k,address:t.address,latitude:t.latitude,longitude:t.longitude}))},F=(t=>M.find(k=>k.id===t))(m),ee=(g==null?void 0:g.items)||[];return e.jsxs(e.Fragment,{children:[e.jsx(ne,{title:"Booking Management",subName:"Apps"}),e.jsx(S,{children:e.jsx(y,{xs:12,children:e.jsx(O,{children:e.jsxs(O.Body,{children:[e.jsxs(f,{variant:"tabs",className:"nav-bordered mb-4",children:[e.jsx(f.Item,{children:e.jsxs(f.Link,{active:n==="new",onClick:()=>d("new"),className:"d-flex align-items-center gap-2",children:["New",w.new>0&&e.jsx(x,{bg:"danger",className:"ms-1",children:w.new})]})}),e.jsx(f.Item,{children:e.jsxs(f.Link,{active:n==="verification",onClick:()=>d("verification"),className:"d-flex align-items-center gap-2",children:["Verification Due",w.verification>0]})}),e.jsx(f.Item,{children:e.jsxs(f.Link,{active:n==="approval",onClick:()=>d("approval"),className:"d-flex align-items-center gap-2",children:["Approval Due",w.approval>0]})}),e.jsx(f.Item,{children:e.jsxs(f.Link,{active:n==="processed",onClick:()=>d("processed"),className:"d-flex align-items-center gap-2",children:["Processed",w.processed>0]})})]}),e.jsx(S,{className:"mb-4",children:e.jsx(y,{md:12,children:e.jsxs("div",{className:"position-relative",children:[e.jsx("i",{className:"mdi mdi-magnify position-absolute top-50 start-0 translate-middle-y ms-3 text-muted",style:{fontSize:"18px"}}),e.jsx(i.Control,{type:"text",placeholder:"Search bookings by customer name...",value:j,onChange:t=>p(t.target.value),className:"ps-5"})]})})}),e.jsx(S,{className:"mb-4",children:e.jsx(y,{xs:12,children:e.jsxs(xe,{className:"mb-2",children:[e.jsxs(b,{variant:"primary",size:"sm",onClick:()=>h(!0),children:[e.jsx("i",{className:"mdi mdi-plus me-1"}),"Create Booking"]}),e.jsxs(b,{variant:"secondary",size:"sm",onClick:()=>Y(),children:[e.jsx("i",{className:"mdi mdi-refresh me-1"}),"Reload"]})]})})}),q&&e.jsxs(_,{variant:"danger",children:[e.jsx("strong",{children:"Error:"})," ",q instanceof Error?q.message:"Failed to load bookings"]}),T?e.jsxs("div",{className:"text-center py-5",children:[e.jsx(E,{animation:"border",variant:"primary"}),e.jsx("p",{className:"mt-2",children:"Loading bookings..."})]}):g!=null&&g.items&&g.items.length>0?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-centered table-striped table-hover",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Customer Name"}),e.jsx("th",{children:"Phone"}),e.jsx("th",{children:"Address"}),e.jsx("th",{children:"Booking Time"}),e.jsx("th",{children:"Items"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Created At"})]})}),e.jsx("tbody",{children:ee.map(t=>e.jsxs("tr",{style:{cursor:"pointer"},onClick:()=>s(`/apps/booking/${t.id}`),children:[e.jsx("td",{children:e.jsx("strong",{children:t.customerName||"N/A"})}),e.jsx("td",{children:t.customerPhone||"-"}),e.jsx("td",{className:"text-muted",children:e.jsx("small",{children:t.address||"-"})}),e.jsx("td",{children:new Date(t.bookingTime).toLocaleString("vi-VN")}),e.jsx("td",{children:t.items&&t.items.length>0?e.jsxs(x,{bg:"info",children:[t.items.length," items"]}):t.totalPrice?e.jsxs(x,{bg:"secondary",children:[t.totalPrice.toLocaleString("vi-VN")," VND"]}):e.jsx("span",{className:"text-muted",children:"-"})}),e.jsx("td",{children:typeof t.status=="number"?e.jsxs(e.Fragment,{children:[t.status===1&&e.jsx(x,{bg:"info",children:"Created"}),t.status===2&&e.jsx(x,{bg:"primary",children:"Assigned"}),t.status===3&&e.jsx(x,{bg:"warning",children:"In Progress"}),t.status===4&&e.jsx(x,{bg:"success",children:"Done"}),t.status===5&&e.jsx(x,{bg:"danger",children:"Failed"}),t.status===6&&e.jsx(x,{bg:"secondary",children:"Cancelled"}),[1,2,3,4,5,6].indexOf(t.status)===-1&&e.jsxs(x,{bg:"secondary",children:["Status ",t.status]})]}):e.jsx(x,{bg:"info",children:t.status||"Unknown"})}),e.jsx("td",{children:t.createdAt?new Date(t.createdAt).toLocaleDateString("vi-VN"):"-"})]},t.id))})]})}),e.jsx(S,{className:"mt-4",children:e.jsx(y,{xs:12,children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{className:"text-muted",children:["Showing ",g.items.length," of ",g.total," bookings"]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx(b,{variant:"secondary",size:"sm",disabled:a===1,onClick:()=>r(a-1),children:"Previous"}),e.jsxs(b,{variant:"secondary",size:"sm",disabled:!0,children:["Page ",a," of ",g.totalPages]}),e.jsx(b,{variant:"secondary",size:"sm",disabled:a>=g.totalPages,onClick:()=>r(a+1),children:"Next"})]})]})})})]}):e.jsxs("div",{className:"text-center py-5",children:[e.jsx("p",{className:"text-muted",children:"No bookings found"}),e.jsx(b,{variant:"primary",onClick:()=>h(!0),children:"Create First Booking"})]})]})})})}),e.jsxs(A,{show:C,onHide:()=>h(!1),size:"lg",children:[e.jsx(A.Header,{closeButton:!0,children:e.jsx(A.Title,{children:"Create New Booking"})}),e.jsxs(i,{onSubmit:X,children:[e.jsxs(A.Body,{children:[P.isError&&e.jsxs(_,{variant:"danger",dismissible:!0,children:["Failed to create booking: ",((G=P.error)==null?void 0:G.message)||"Unknown error"]}),e.jsxs(S,{children:[e.jsx(y,{md:6,children:e.jsxs(i.Group,{className:"mb-3",children:[e.jsx(i.Label,{children:"Customer Name *"}),e.jsx(i.Control,{type:"text",placeholder:"Enter customer name",value:o.customerName,onChange:t=>u({...o,customerName:t.target.value}),required:!0})]})}),e.jsx(y,{md:6,children:e.jsxs(i.Group,{className:"mb-3",children:[e.jsx(i.Label,{children:"Customer Phone *"}),e.jsx(i.Control,{type:"tel",placeholder:"0352978519",value:o.customerPhone,onChange:t=>u({...o,customerPhone:t.target.value}),required:!0})]})})]}),e.jsxs(i.Group,{className:"mb-3",children:[e.jsx(i.Label,{children:"Customer ID *"}),e.jsx(i.Control,{type:"text",placeholder:"Enter customer ID (UUID)",value:o.customerId,onChange:t=>u({...o,customerId:t.target.value}),required:!0})]}),e.jsxs(i.Group,{className:"mb-3",children:[e.jsx(i.Label,{children:"Address *"}),e.jsx(ve,{value:o.address,onPlaceSelected:W,placeholder:"Search for an address using Google Maps",required:!0})]}),o.latitude!==0&&o.longitude!==0&&e.jsx(_,{variant:"info",className:"mb-3",children:e.jsxs("small",{children:[e.jsx("strong",{children:"Coordinates:"})," ",o.latitude.toFixed(6),", ",o.longitude.toFixed(6)]})}),e.jsxs(i.Group,{className:"mb-3",children:[e.jsx(i.Label,{children:"Booking Time *"}),e.jsx(i.Control,{type:"datetime-local",value:o.bookingTime,onChange:t=>u({...o,bookingTime:t.target.value}),required:!0})]}),e.jsxs(S,{children:[e.jsx(y,{md:8,children:e.jsxs(i.Group,{className:"mb-3",children:[e.jsx(i.Label,{children:"Select Product *"}),J?e.jsxs("div",{className:"text-center py-2",children:[e.jsx(E,{animation:"border",size:"sm"}),e.jsx("span",{className:"ms-2",children:"Loading products..."})]}):e.jsxs(i.Select,{value:m,onChange:t=>B(t.target.value),required:!0,children:[e.jsx("option",{value:"",children:"-- Select a product --"}),M.map(t=>e.jsxs("option",{value:t.id,children:[t.name," - ",t.price.toLocaleString("vi-VN")," VND"]},t.id))]})]})}),e.jsx(y,{md:4,children:e.jsxs(i.Group,{className:"mb-3",children:[e.jsx(i.Label,{children:"Quantity *"}),e.jsx(i.Control,{type:"number",min:"1",value:v,onChange:t=>N(parseInt(t.target.value)||1),required:!0})]})})]}),F&&e.jsxs(_,{variant:"info",className:"mb-3",children:[e.jsx("strong",{children:"Selected:"})," ",F.name," x ",v,e.jsx("br",{}),e.jsx("small",{className:"text-muted",children:F.description}),e.jsx("hr",{className:"my-2"}),e.jsxs("strong",{children:["Total: ",(F.price*v).toLocaleString("vi-VN")," VND"]})]})]}),e.jsxs(A.Footer,{children:[e.jsx(b,{variant:"secondary",onClick:()=>h(!1),disabled:P.isPending,children:"Cancel"}),e.jsx(b,{variant:"primary",type:"submit",disabled:P.isPending||!m||!o.address,children:P.isPending?e.jsxs(e.Fragment,{children:[e.jsx(E,{animation:"border",size:"sm",className:"me-2"}),"Creating..."]}):"Create Booking"})]})]})]})]})},Pe=c.lazy(()=>ie(()=>import("./BookingDetail-5f874cb2.js"),["assets/BookingDetail-5f874cb2.js","assets/index-1c09459b.js","assets/index-fab365ac.css","assets/useProducts-ffefb872.js","assets/useQuery-00218134.js","assets/useMutation-cc409948.js","assets/Alert-582bd80a.js","assets/hook-95b25f1d.js","assets/Spinner-ed2097a1.js","assets/Button-f56a0820.js","assets/Table-3ddf39e5.js","assets/Badge-8e317aab.js","assets/Form-9237be30.js","assets/FormControl-e238e16f.js","assets/ElementChildren-ab2d58d5.js","assets/Nav-2f954c07.js","assets/DataKey-e12315fd.js","assets/NavContext-6ce83af4.js","assets/useMergedRefs-7e23477e.js","assets/NavbarContext-25385990.js","assets/ButtonGroup-17e0a310.js","assets/Modal-1b87b88a.js","assets/AbstractModalHeader-a20fb1bf.js","assets/useWindow-687076da.js","assets/hasClass-87521f5b.js"])),Se=()=>(console.log("[Booking] Routes component rendered"),e.jsxs(le,{children:[e.jsx(V,{index:!0,element:e.jsx(Be,{})}),e.jsx(V,{path:":id",element:e.jsx(c.Suspense,{fallback:e.jsxs("div",{className:"text-center py-5",children:[e.jsx(E,{animation:"border",variant:"primary"}),e.jsx("p",{className:"mt-2",children:"Loading booking details..."})]}),children:e.jsx(Pe,{})})})]})),Ue=Object.freeze(Object.defineProperty({__proto__:null,default:Se},Symbol.toStringTag,{value:"Module"}));export{Ue as i,Ve as u};
