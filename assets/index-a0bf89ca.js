import{j as e,L as te,r as h,P as ne,d as f,f as d,h as I,ac as ie}from"./index-f24fabb9.js";import{S as W}from"./react-select.esm-2d998b52.js";import{M as $,C as F,F as oe}from"./react-select-creatable.esm-c3bb10c6.js";import{u as le,a as ce,b as de,c as ue}from"./useProducts-3becb29e.js";import{u as me}from"./useCategories-1f930590.js";import{B as u}from"./Badge-41b97b48.js";import{B as p}from"./Button-1bd665f7.js";import{A as he}from"./Alert-f3b59418.js";import{S as _}from"./Spinner-c6839ba2.js";import{M as L}from"./Modal-4d26d06f.js";import{F as i}from"./Form-93705b7c.js";import"./hook-c08bc9e4.js";import"./index.esm-f39bb473.js";import"./InputGroupContext-7aefe718.js";import"./useQuery-ef7bc5d7.js";import"./useMutation-bf1cb67e.js";import"./AbstractModalHeader-5af54cd0.js";import"./useWindow-e030e9b1.js";import"./hasClass-2aefdf69.js";import"./useMergedRefs-cc67f583.js";import"./DataKey-e12315fd.js";import"./ElementChildren-33f86963.js";const pe=[{Header:"ID",accessor:"id",defaultCanSort:!1,Cell:({value:l})=>e.jsxs("small",{className:"text-muted",children:[l.substring(0,8),"..."]})},{Header:"Name",accessor:"name",defaultCanSort:!0,Cell:({value:l})=>e.jsx("strong",{children:l})},{Header:"Type",accessor:"type",defaultCanSort:!0,Cell:({value:l})=>{switch(l){case 1:return e.jsx(u,{bg:"primary",children:"Service"});case 2:return e.jsx(u,{bg:"info",children:"Variant"});case 3:return e.jsx(u,{bg:"success",children:"Addon"});default:return e.jsx(u,{bg:"secondary",children:"Unknown"})}}},{Header:"Price",accessor:"price",defaultCanSort:!0,Cell:({value:l})=>{const b=l.toLocaleString("vi-VN",{minimumFractionDigits:0,maximumFractionDigits:0});return e.jsxs("span",{children:["â‚«",b]})}},{Header:"Duration",accessor:"duration",defaultCanSort:!0,Cell:({value:l})=>`${l} min`},{Header:"Category ID",accessor:"categoryId",defaultCanSort:!1,Cell:({value:l})=>e.jsxs("small",{className:"text-muted",children:[l.substring(0,8),"..."]})},{Header:"Level Code",accessor:"categoryLevelCode",defaultCanSort:!1,Cell:({value:l})=>e.jsx(u,{bg:"info",children:l})},{Header:"Description",accessor:"description",defaultCanSort:!1,Cell:({value:l})=>e.jsx("span",{className:"text-muted",children:l})},{Header:"Created At",accessor:"createdAt",defaultCanSort:!0,Cell:({value:l})=>new Date(l).toLocaleDateString()},{Header:"Actions",id:"actions",accessor:"id",defaultCanSort:!1,Cell:({value:l})=>e.jsx(te,{to:`/apps/products/${l}`,children:e.jsxs(p,{variant:"outline-primary",size:"sm",children:[e.jsx("i",{className:"mdi mdi-eye me-1"}),"View"]})})}],A=[{value:15,label:"15 minutes"},{value:30,label:"30 minutes"},{value:45,label:"45 minutes"},{value:60,label:"1 hour"},{value:90,label:"1.5 hours"},{value:120,label:"2 hours"},{value:180,label:"3 hours"},{value:240,label:"4 hours"},{value:300,label:"5 hours"}],xe=[{text:"10",value:10},{text:"25",value:25},{text:"50",value:50}],ge=()=>{const[l,b]=h.useState(!1),[o,x]=h.useState({categoryId:"",categoryLevelCode:"",name:"",price:0,duration:0,description:""}),[g,G]=h.useState([]),[m,w]=h.useState([]),[M,O]=h.useState([]),{data:N,isLoading:T,error:P}=le(),{data:C,isLoading:X}=me(),S=ce(),U=de(),Y=ue(),H=h.useMemo(()=>N?N.filter(s=>s.type===2):[],[N]),k=h.useMemo(()=>C?C.map(s=>({value:s.id,label:`${s.levelCode} - ${s.name}`})):[],[C]),J=h.useMemo(()=>o.categoryId&&k.find(s=>s.value===o.categoryId)||null,[o.categoryId,k]),K=s=>{if(s){const r=C==null?void 0:C.find(a=>a.id===s.value);r&&x({...o,categoryId:r.id,categoryLevelCode:r.levelCode})}else x({...o,categoryId:"",categoryLevelCode:""})},Q=()=>{G([...g,{name:"",price:0,duration:0,description:""}])},Z=s=>{G(g.filter((r,a)=>a!==s))},V=(s,r,a)=>{const n=[...g];n[s]={...n[s],[r]:a},G(n)},ee=()=>{w([...m,{name:"",price:0,duration:0,description:"",variantIndices:[],existingVariantIds:[]}])},ae=s=>{w(m.filter((r,a)=>a!==s))},D=(s,r,a)=>{w(n=>{const t=[...n];return t[s]={...t[s],[r]:a},t})},se=(s,r,a)=>{console.log("[DEBUG] updateAddonVariants called:",{index:s,variantIndices:r,existingVariantIds:a,currentAddonsState:m}),w(n=>{const t=[...n];return t[s]={...t[s],variantIndices:r,existingVariantIds:a},console.log("[DEBUG] updateAddonVariants - new state:",{index:s,updatedAddon:t[s],allAddons:t}),t})};h.useEffect(()=>{console.log("[DEBUG] Addons state changed:",{addons:m,addonsWithVariants:m.map((s,r)=>({index:r,name:s.name,variantIndices:s.variantIndices,existingVariantIds:s.existingVariantIds}))})},[m]);const B=h.useMemo(()=>{const s=g.map((n,t)=>({value:`new_${t}`,label:n.name||`New Variant ${t+1}`,isNew:!0,index:t})),r=H.map(n=>({value:`existing_${n.id}`,label:n.name,isNew:!1,id:n.id})),a=[];return s.length>0&&a.push({label:`New Variants (${s.length})`,options:s}),r.length>0&&a.push({label:`Existing Variants (${r.length})`,options:r}),a.length>0?a:[]},[g,H]),z=()=>{x({categoryId:"",categoryLevelCode:"",name:"",price:0,duration:0,description:""}),G([]),w([]),O([])},re=async s=>{s.preventDefault(),console.log("[DEBUG] Form submission started. Current addons state:",{addons:m,addonsCount:m.length,addonsWithVariants:m.map((r,a)=>({index:a,name:r.name,variantIndices:r.variantIndices,existingVariantIds:r.existingVariantIds}))});try{const r={...o,type:1},a=await S.mutateAsync(r);M.length>0&&await Y.mutateAsync({productId:a.id,images:M});const n=[];for(const t of g){const j={...o,...t,type:2},c=await S.mutateAsync(j);n.push(c.id),console.log("[DEBUG] Created Variant:",{variantId:c.id,variantName:c.name,serviceId:a.id});const v={productId:a.id,productReferenceId:c.id};console.log("[DEBUG] Linking Variant to Service:",v),await U.mutateAsync(v),console.log("[DEBUG] Successfully linked Variant to Service")}for(const t of m){const j={...o,name:t.name,price:t.price,duration:t.duration,description:t.description,type:3},c=await S.mutateAsync(j);console.log("[DEBUG] Created Addon:",{addonId:c.id,addonName:c.name,serviceId:a.id,variantIndices:t.variantIndices,existingVariantIds:t.existingVariantIds,allVariantIds:n}),console.log("[DEBUG] Skipping addon-service link. Addons only link to variants."),console.log("[DEBUG] Linking Variant to Addon (NEW). Count:",t.variantIndices.length);for(const v of t.variantIndices){const y=n[v];if(console.log("[DEBUG] Processing variant index:",{variantIndex:v,variantId:y,variantIdsArray:n}),y){const E={productId:y,productReferenceId:c.id};console.log("[DEBUG] Linking Variant to Addon (NEW):",E);try{await U.mutateAsync(E),console.log("[DEBUG] Successfully linked Variant to Addon (NEW)")}catch(R){throw console.error("[DEBUG] Failed to link Variant to Addon (NEW):",R),R}}else console.warn("[DEBUG] Variant ID not found for index:",v)}console.log("[DEBUG] Linking Variant to Addon (EXISTING). Count:",t.existingVariantIds.length);for(const v of t.existingVariantIds){const y={productId:v,productReferenceId:c.id};console.log("[DEBUG] Linking Variant to Addon (EXISTING):",y);try{await U.mutateAsync(y),console.log("[DEBUG] Successfully linked Variant to Addon (EXISTING)")}catch(E){throw console.error("[DEBUG] Failed to link Variant to Addon (EXISTING):",E),E}}}z(),b(!1)}catch{}},q=()=>{z(),b(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(ne,{title:"Products",subName:"Apps"}),e.jsx(f,{children:e.jsx(d,{xs:12,children:e.jsx(I,{children:e.jsxs(I.Body,{children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-4",children:[e.jsx("h4",{className:"header-title",children:"Products List"}),e.jsxs(p,{variant:"primary",onClick:()=>b(!0),children:[e.jsx("i",{className:"mdi mdi-plus-circle me-1"}),"Create Product"]})]}),P&&e.jsxs(he,{variant:"danger",children:[e.jsx("strong",{children:"Error:"})," ",P instanceof Error?P.message:"Failed to load products"]}),T?e.jsxs("div",{className:"text-center py-5",children:[e.jsx(_,{animation:"border",variant:"primary"}),e.jsx("p",{className:"mt-2",children:"Loading products..."})]}):N&&N.length>0?e.jsx(ie,{columns:pe,data:N,pageSize:10,sizePerPageList:xe,isSortable:!0,pagination:!0,isSearchable:!0}):e.jsxs("div",{className:"text-center py-5",children:[e.jsx("p",{className:"text-muted",children:"No products found"}),e.jsx(p,{variant:"primary",onClick:()=>b(!0),children:"Create First Product"})]})]})})})}),e.jsxs(L,{show:l,onHide:q,size:"xl",scrollable:!0,centered:!0,children:[e.jsx(L.Header,{closeButton:!0,children:e.jsx(L.Title,{children:"Create New Product (Service + Variants + Addons)"})}),e.jsxs(i,{onSubmit:re,children:[e.jsxs(L.Body,{style:{maxHeight:"70vh",overflowY:"auto"},children:[e.jsxs("div",{className:"mb-4",children:[e.jsxs(f,{children:[e.jsx(d,{md:6,children:e.jsxs(i.Group,{className:"mb-3",children:[e.jsx(i.Label,{children:"Service Name *"}),e.jsx(i.Control,{type:"text",placeholder:"Enter service name",value:o.name,onChange:s=>x({...o,name:s.target.value}),required:!0})]})}),e.jsx(d,{md:6,children:e.jsxs(i.Group,{className:"mb-3",children:[e.jsx(i.Label,{children:"Category *"}),e.jsx(W,{className:"react-select",classNamePrefix:"react-select",options:k,value:J,onChange:K,placeholder:"Select a category",isDisabled:X,isClearable:!0,isSearchable:!0}),o.categoryLevelCode&&e.jsxs(i.Text,{className:"text-muted d-block mt-1",children:["Level Code: ",e.jsx("strong",{children:o.categoryLevelCode})]})]})})]}),e.jsxs(f,{children:[e.jsx(d,{md:6,children:e.jsx($,{label:"Price *",placeholder:"0",currency:"VND",value:o.price,onChange:s=>x({...o,price:s}),required:!0,containerClass:"mb-3"})}),e.jsx(d,{md:6,children:e.jsxs(i.Group,{className:"mb-3",children:[e.jsx(i.Label,{children:"Duration (minutes) *"}),e.jsx(F,{className:"react-select",classNamePrefix:"react-select",options:A,value:o.duration?A.find(s=>s.value===o.duration)||{value:o.duration,label:`${o.duration} minutes`}:null,onChange:s=>{const r=s?typeof s.value=="number"?s.value:parseInt(s.value):0;x({...o,duration:r})},onCreateOption:s=>{const r=parseInt(s)||0;x({...o,duration:r})},placeholder:"Select or enter duration...",isClearable:!1,formatCreateLabel:s=>`Use ${s} minutes`,required:!0})]})})]}),e.jsxs(i.Group,{className:"mb-3",children:[e.jsx(i.Label,{children:"Description *"}),e.jsx(i.Control,{as:"textarea",rows:3,placeholder:"Enter service description",value:o.description,onChange:s=>x({...o,description:s.target.value}),required:!0})]})]}),e.jsx("hr",{className:"my-4"}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsxs("div",{children:[e.jsxs("h5",{className:"mb-0 d-inline me-3",children:[e.jsx(u,{bg:"info",className:"me-2",children:"2"}),"Variants (Type 2)"]}),e.jsxs("h5",{className:"mb-0 d-inline",children:[e.jsx(u,{bg:"success",className:"me-2",children:"3"}),"Addons (Type 3)"]})]}),e.jsxs("div",{children:[e.jsxs(p,{variant:"outline-primary",size:"sm",onClick:Q,className:"me-2",children:[e.jsx("i",{className:"mdi mdi-plus me-1"})," Add Variant"]}),e.jsxs(p,{variant:"outline-success",size:"sm",onClick:ee,children:[e.jsx("i",{className:"mdi mdi-plus me-1"})," Add Addon"]})]})]}),g.length===0&&m.length===0?e.jsx("p",{className:"text-muted",children:'No variants or addons added. Click "Add Variant" or "Add Addon" to add one.'}):e.jsxs(f,{className:"g-3",children:[g.map((s,r)=>e.jsx(d,{xs:12,md:6,children:e.jsx(I,{className:"h-100 border-info",children:e.jsxs(I.Body,{children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsxs("h6",{className:"mb-0",children:[e.jsx(u,{bg:"info",className:"me-2",children:"Variant"}),"Variant ",r+1]}),e.jsx(p,{variant:"outline-danger",size:"sm",onClick:()=>Z(r),children:e.jsx("i",{className:"mdi mdi-close"})})]}),e.jsx(f,{children:e.jsx(d,{md:12,children:e.jsxs(i.Group,{className:"mb-3",children:[e.jsx(i.Label,{children:"Variant Name *"}),e.jsx(i.Control,{type:"text",placeholder:"Enter variant name",value:s.name,onChange:a=>V(r,"name",a.target.value),required:!0})]})})}),e.jsxs(f,{children:[e.jsx(d,{md:6,children:e.jsx($,{label:"Price *",placeholder:"0",currency:"VND",value:s.price,onChange:a=>V(r,"price",a),required:!0,containerClass:"mb-3"})}),e.jsx(d,{md:6,children:e.jsxs(i.Group,{className:"mb-3",children:[e.jsx(i.Label,{children:"Duration (min) *"}),e.jsx(F,{className:"react-select",classNamePrefix:"react-select",options:A,value:s.duration?A.find(a=>a.value===s.duration)||{value:s.duration,label:`${s.duration} minutes`}:null,onChange:a=>{const n=a?typeof a.value=="number"?a.value:parseInt(a.value):0;V(r,"duration",n)},onCreateOption:a=>{const n=parseInt(a)||0;V(r,"duration",n)},placeholder:"Select or enter duration...",isClearable:!1,formatCreateLabel:a=>`Use ${a} minutes`})]})})]}),e.jsxs(i.Group,{className:"mb-0",children:[e.jsx(i.Label,{children:"Description *"}),e.jsx(i.Control,{as:"textarea",rows:2,placeholder:"Enter variant description",value:s.description,onChange:a=>V(r,"description",a.target.value),required:!0})]})]})})},`variant-${r}`)),m.map((s,r)=>e.jsx(d,{xs:12,md:6,children:e.jsx(I,{className:"h-100 border-success",children:e.jsxs(I.Body,{children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsxs("h6",{className:"mb-0",children:[e.jsx(u,{bg:"success",className:"me-2",children:"Addon"}),"Addon ",r+1]}),e.jsx(p,{variant:"outline-danger",size:"sm",onClick:()=>ae(r),children:e.jsx("i",{className:"mdi mdi-close"})})]}),e.jsx(f,{children:e.jsx(d,{md:12,children:e.jsxs(i.Group,{className:"mb-3",children:[e.jsx(i.Label,{children:"Addon Name *"}),e.jsx(i.Control,{type:"text",placeholder:"Enter addon name",value:s.name,onChange:a=>D(r,"name",a.target.value),required:!0})]})})}),e.jsxs(f,{children:[e.jsx(d,{md:6,children:e.jsx($,{label:"Price *",placeholder:"0",currency:"VND",value:s.price,onChange:a=>D(r,"price",a),required:!0,containerClass:"mb-3"})}),e.jsx(d,{md:6,children:e.jsxs(i.Group,{className:"mb-3",children:[e.jsx(i.Label,{children:"Duration (min) *"}),e.jsx(F,{className:"react-select",classNamePrefix:"react-select",options:A,value:s.duration?A.find(a=>a.value===s.duration)||{value:s.duration,label:`${s.duration} minutes`}:null,onChange:a=>{const n=a?typeof a.value=="number"?a.value:parseInt(a.value):0;D(r,"duration",n)},onCreateOption:a=>{const n=parseInt(a)||0;D(r,"duration",n)},placeholder:"Select or enter duration...",isClearable:!1,formatCreateLabel:a=>`Use ${a} minutes`})]})})]}),e.jsxs(i.Group,{className:"mb-3",children:[e.jsx(i.Label,{children:"Link to Variants (Optional)"}),e.jsx(W,{isMulti:!0,className:"react-select",classNamePrefix:"react-select",options:B,value:(()=>{const a=[];return B.forEach(n=>{n.options&&n.options.forEach(t=>{(t.isNew&&s.variantIndices.includes(t.index)||!t.isNew&&s.existingVariantIds.includes(t.id))&&a.push(t)})}),a})(),getOptionValue:a=>a.isNew?`new_${a.index}`:`existing_${a.id}`,formatGroupLabel:a=>e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("span",{className:"fw-bold",children:a.label}),e.jsx(u,{bg:a.label.includes("New")?"info":"secondary",className:"ms-2",children:a.options.length})]}),formatOptionLabel:(a,{context:n})=>n==="value"?a.label:e.jsxs("div",{className:"d-flex align-items-center",children:[a.isNew&&e.jsx(u,{bg:"info",className:"me-2",style:{fontSize:"0.7rem"},children:"New"}),!a.isNew&&e.jsx(u,{bg:"secondary",className:"me-2",style:{fontSize:"0.7rem"},children:"Existing"}),e.jsx("span",{children:a.label})]}),onChange:a=>{console.log("[DEBUG] Variant Selection onChange triggered:",{addonIndex:r,selected:a,selectedType:Array.isArray(a)?"array":typeof a,selectedLength:Array.isArray(a)?a.length:"not array"});const n=[],t=[];if(a){const j=Array.isArray(a)?a:[a];console.log("[DEBUG] Processing selected variants:",{selectedArray:j,count:j.length}),j.forEach(c=>{console.log("[DEBUG] Processing option:",{option:c,isNew:c.isNew,index:c.index,id:c.id}),c.isNew?n.push(c.index):t.push(c.id)})}console.log("[DEBUG] Updating addon with:",{addonIndex:r,variantIndices:n,existingVariantIds:t}),se(r,n,t),console.log("[DEBUG] State update called for addon variants")},placeholder:"Search and select variants...",isSearchable:!0,isClearable:!0,isDisabled:B.length===0,isLoading:T,noOptionsMessage:({inputValue:a})=>a?`No variants found matching "${a}"`:"No variants available. Add new variants above or create variants first.",filterOption:(a,n)=>{var c;if(!n)return!0;const t=n.toLowerCase();return(((c=a.label)==null?void 0:c.toLowerCase())||"").includes(t)}}),e.jsx(i.Text,{className:"text-muted",children:B.length===0?"No variants available. Add new variants above or create variants first.":"Search and select variants from new ones being created or existing ones from the database. You can select multiple variants."})]}),e.jsxs(i.Group,{className:"mb-0",children:[e.jsx(i.Label,{children:"Description *"}),e.jsx(i.Control,{as:"textarea",rows:2,placeholder:"Enter addon description",value:s.description,onChange:a=>D(r,"description",a.target.value),required:!0})]})]})})},`addon-${r}`))]})]}),e.jsx("hr",{className:"my-4"}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("h5",{className:"mb-3",children:[e.jsx(u,{bg:"secondary",className:"me-2",children:"Images"}),"Product Images (Optional)"]}),e.jsxs(i.Group,{className:"mb-3",children:[e.jsx(oe,{showPreview:!0,onFileUpload:s=>O(s)}),e.jsx(i.Text,{className:"text-muted",children:"Upload multiple images for this product. Images will be associated with the service."})]})]})]}),e.jsxs(L.Footer,{children:[e.jsx(p,{variant:"secondary",onClick:q,children:"Cancel"}),e.jsx(p,{variant:"primary",type:"submit",disabled:S.isPending,children:S.isPending?e.jsxs(e.Fragment,{children:[e.jsx(_,{animation:"border",size:"sm",className:"me-2"}),"Creating..."]}):"Create Product"})]})]})]})]})},Me=()=>e.jsx(ge,{});export{Me as default};
