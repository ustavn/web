import{j as e,r,P as G,d as k,f as p,h as H,ac as J}from"./index-c947d73c.js";import{g as U,u as K,a as Q,b as Z,c as W}from"./useTechnicians-35f3a734.js";import{u as X}from"./useQuery-e382baee.js";import{u as Y}from"./useShifts-416a60d5.js";import{B as _}from"./ButtonGroup-60f3627d.js";import{B as u}from"./Button-3c824970.js";import{S as b}from"./Spinner-385056f3.js";import{B as d}from"./Badge-5adff270.js";import{F as P}from"./Form-e8afece7.js";import{A as V}from"./Alert-8dbb89a3.js";import{M as N}from"./Modal-a0be62a7.js";import{T as ee}from"./Table-bf5e2dbe.js";import"./useMutation-1e28e3fa.js";import"./hook-20466ebe.js";import"./AbstractModalHeader-908d2567.js";import"./useWindow-e0ec882a.js";import"./hasClass-6653d1f3.js";import"./useMergedRefs-73da3a82.js";import"./DataKey-e12315fd.js";function se(l,x={},j=!0){return X({queryKey:["technician-shifts",l,x],queryFn:()=>U(l,x),enabled:!!l&&j,staleTime:3e4,retry:2,select:o=>o||[]})}const ae=({onApprove:l,onReject:x,onViewDetail:j,processingId:o,isApproving:y,isRejecting:S,needsApproval:g,getStatusBadge:v,getRatingStars:f})=>[{Header:"Name",accessor:"name",defaultCanSort:!0,Cell:({row:n})=>{const t=n.original;return e.jsxs("div",{children:[e.jsx("strong",{children:t.name}),t.address&&e.jsx("div",{className:"text-muted small",children:t.address})]})}},{Header:"Phone",accessor:"phone",defaultCanSort:!0},{Header:"Email",accessor:"email",defaultCanSort:!0,Cell:({value:n})=>n||e.jsx("span",{className:"text-muted",children:"-"})},{Header:"Specialization",accessor:"specialization",defaultCanSort:!1,Cell:({value:n})=>n||e.jsx("span",{className:"text-muted",children:"-"})},{Header:"Rating",accessor:"rating",defaultCanSort:!0,Cell:({row:n})=>{const t=n.original;return f(t.rating)}},{Header:"Status",accessor:"status",defaultCanSort:!0,Cell:({row:n})=>{const t=n.original;return v(t.status)}},{Header:"Created At",accessor:"createdAt",defaultCanSort:!0,Cell:({value:n})=>new Date(n).toLocaleDateString("vi-VN")},{Header:"Actions",accessor:"id",defaultCanSort:!1,Cell:({row:n})=>{const t=n.original,m=o===t.id,a=g(t);return e.jsx("div",{className:"d-flex gap-1",children:e.jsxs(_,{size:"sm",className:"gap-1",children:[e.jsx(u,{variant:"info",onClick:h=>{h.stopPropagation(),j(t)},title:"View Details",children:e.jsx("i",{className:"mdi mdi-eye"})}),a&&e.jsxs(e.Fragment,{children:[e.jsx(u,{variant:"success",onClick:h=>{h.stopPropagation(),l(t)},disabled:m,title:"Approve",children:m&&y?e.jsxs(e.Fragment,{children:[e.jsx(b,{animation:"border",size:"sm",className:"me-1"}),"Approving..."]}):"Approve"}),e.jsx(u,{variant:"danger",onClick:h=>{h.stopPropagation(),x(t)},disabled:m,title:"Reject",children:m&&S?e.jsxs(e.Fragment,{children:[e.jsx(b,{animation:"border",size:"sm",className:"me-1"}),"Rejecting..."]}):"Reject"})]})]})})}}],ie=[{text:"10",value:10},{text:"25",value:25},{text:"50",value:50},{text:"100",value:100}],te=()=>{const[l,x]=r.useState(void 0),[j,o]=r.useState(null),[y,S]=r.useState(null),[g,v]=r.useState(!1),{data:f=[],isLoading:n,error:t,refetch:m}=K(l!==void 0?{status:l}:{}),{data:a,isLoading:h,error:z}=Q(y||""),E=r.useMemo(()=>{const s=new Date;return s.setDate(s.getDate()-30),{from:s.toISOString(),page:1,pageSize:100}},[g]),{data:F=[],isLoading:$}=se(y||"",E,g),{data:O=[]}=Y({}),C=Z(),A=W(),T=r.useCallback(s=>{switch(s){case 1:return e.jsx(d,{bg:"info",children:"Pending"});case 2:return e.jsx(d,{bg:"success",children:"Approved"});case 3:return e.jsx(d,{bg:"danger",children:"Rejected"});default:return e.jsx(d,{bg:"secondary",children:"Unknown"})}},[]),w=r.useCallback(s=>s.status===1,[]),L=r.useCallback(async s=>{if(!w(s))return;const i=s.name||s.phone||s.id||"this technician";if(window.confirm(`Are you sure you want to approve ${i}?`)){o(s.id);try{await C.mutateAsync({technicianId:s.id,profileId:s.profileId,skills:s.skills,zones:s.zones})}catch{}finally{o(null)}}},[w,C]),R=r.useCallback(async s=>{const i=s.name||s.phone||s.id||"this technician",c=window.prompt(`Enter reason for rejecting ${i} (optional):`);if(c!==null&&window.confirm(`Are you sure you want to reject ${i}?`)){o(s.id);try{await A.mutateAsync({technicianId:s.id,reason:c||void 0})}catch{}finally{o(null)}}},[A]),D=r.useCallback(s=>{if(!s)return e.jsx("span",{className:"text-muted",children:"No rating"});const i="â­".repeat(Math.round(s));return e.jsxs("span",{children:[i," (",s.toFixed(1),")"]})},[]),I=r.useCallback(s=>{S(s.id),v(!0)},[]),B=r.useCallback(()=>{v(!1),S(null)},[]),q=r.useMemo(()=>ae({onApprove:L,onReject:R,onViewDetail:I,processingId:j,isApproving:C.isPending,isRejecting:A.isPending,needsApproval:w,getStatusBadge:T,getRatingStars:D}),[L,R,I,j,C.isPending,A.isPending,w,T,D]);return e.jsxs(e.Fragment,{children:[e.jsx(G,{title:"Technician Management",subName:"Apps"}),e.jsx(k,{children:e.jsx(p,{xs:12,children:e.jsx(H,{children:e.jsxs(H.Body,{children:[e.jsx(k,{className:"mb-3",children:e.jsx(p,{md:4,children:e.jsxs(P.Group,{children:[e.jsx(P.Label,{children:"Filter by Status"}),e.jsxs(P.Select,{value:l??"",onChange:s=>{const i=s.target.value;x(i===""?void 0:Number(i))},children:[e.jsx("option",{value:"",children:"All"}),e.jsx("option",{value:1,children:"Pending"}),e.jsx("option",{value:2,children:"Approved"}),e.jsx("option",{value:3,children:"Rejected"})]})]})})}),t&&e.jsxs(V,{variant:"danger",dismissible:!0,children:["Failed to load technicians: ",t.message,e.jsx(u,{variant:"link",onClick:()=>m(),children:"Try Again"})]}),n?e.jsxs("div",{className:"text-center py-5",children:[e.jsx(b,{animation:"border",variant:"primary"}),e.jsx("p",{className:"mt-2",children:"Loading technicians..."})]}):f&&f.length>0?e.jsx(J,{columns:q,data:f,pageSize:10,sizePerPageList:ie,isSortable:!0,pagination:!0,isSearchable:!0,theadClass:"table-light"}):e.jsxs("div",{className:"text-center py-5",children:[e.jsx("p",{className:"text-muted",children:"No technicians found"}),e.jsx(u,{variant:"link",onClick:()=>m(),children:"Try Again"})]})]})})})}),e.jsxs(N,{show:g,onHide:B,size:"lg",children:[e.jsx(N.Header,{closeButton:!0,children:e.jsx(N.Title,{children:"Technician Details"})}),e.jsx(N.Body,{children:h?e.jsxs("div",{className:"text-center py-5",children:[e.jsx(b,{animation:"border",variant:"primary"}),e.jsx("p",{className:"mt-2",children:"Loading technician details..."})]}):z?e.jsxs(V,{variant:"danger",children:["Failed to load technician details: ",z.message,e.jsx("div",{className:"mt-2",children:e.jsx(u,{variant:"link",size:"sm",onClick:()=>v(!1),children:"Close"})})]}):a?e.jsxs(k,{children:[e.jsxs(p,{md:6,children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Name:"}),e.jsx("p",{className:"mb-0",children:a.name})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Phone:"}),e.jsx("p",{className:"mb-0",children:a.phone})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Email:"}),e.jsx("p",{className:"mb-0",children:a.email||e.jsx("span",{className:"text-muted",children:"-"})})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Address:"}),e.jsx("p",{className:"mb-0",children:a.address||e.jsx("span",{className:"text-muted",children:"-"})})]})]}),e.jsxs(p,{md:6,children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Status:"}),e.jsx("p",{className:"mb-0",children:T(a.status)})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Specialization:"}),e.jsx("p",{className:"mb-0",children:a.specialization||e.jsx("span",{className:"text-muted",children:"-"})})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Rating:"}),e.jsx("p",{className:"mb-0",children:D(a.rating)})]}),a.updatedAt&&e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Updated At:"}),e.jsx("p",{className:"mb-0",children:new Date(a.updatedAt).toLocaleDateString("vi-VN",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})})]})]}),a.profileId&&e.jsxs(p,{xs:12,children:[e.jsx("hr",{}),e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Profile ID:"}),e.jsx("p",{className:"mb-0 text-muted small",children:a.profileId})]}),a.skills&&a.skills.length>0&&e.jsxs("div",{className:"mb-2",children:[e.jsxs("strong",{children:["Skills (",a.skills.length,"):"]}),e.jsx("div",{className:"mt-1",children:a.skills.map((s,i)=>{const c=typeof s=="string"?s:(s==null?void 0:s.name)||JSON.stringify(s);return e.jsx(d,{bg:"primary",className:"me-1",children:c},i)})})]}),a.zones&&a.zones.length>0&&e.jsxs("div",{className:"mb-2",children:[e.jsxs("strong",{children:["Zones (",a.zones.length,"):"]}),e.jsx("div",{className:"mt-1",children:a.zones.map((s,i)=>{const c=typeof s=="string"?s:(s==null?void 0:s.name)||JSON.stringify(s);return e.jsx(d,{bg:"info",className:"me-1",children:c},i)})})]})]}),e.jsxs(p,{xs:12,children:[e.jsx("hr",{className:"my-3"}),e.jsx("h6",{className:"mb-3",children:"Shifts"}),$?e.jsxs("div",{className:"text-center py-3",children:[e.jsx(b,{animation:"border",size:"sm",variant:"primary"}),e.jsx("p",{className:"mt-2 mb-0 small text-muted",children:"Loading shifts..."})]}):F.length>0?e.jsx("div",{className:"table-responsive",children:e.jsxs(ee,{striped:!0,bordered:!0,hover:!0,size:"sm",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Shift Name"}),e.jsx("th",{children:"Effective From"}),e.jsx("th",{children:"Effective To"}),e.jsx("th",{children:"Status"})]})}),e.jsx("tbody",{children:F.map(s=>{const i=O.find(M=>M.id===s.shiftId),c=(i==null?void 0:i.name)||s.shiftId;return e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx(d,{bg:"primary",children:c})}),e.jsx("td",{children:new Date(s.effectiveFrom).toLocaleDateString("vi-VN",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}),e.jsx("td",{children:new Date(s.effectiveTo).toLocaleDateString("vi-VN",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}),e.jsx("td",{children:s.isActive?e.jsx(d,{bg:"success",children:"Active"}):e.jsx(d,{bg:"secondary",children:"Inactive"})})]},s.id)})})]})}):e.jsx("p",{className:"text-muted small mb-0",children:"No shifts assigned"})]})]}):null}),e.jsx(N.Footer,{children:e.jsx(u,{variant:"secondary",onClick:B,children:"Close"})})]})]})},Ce=()=>e.jsx(te,{});export{Ce as default};
