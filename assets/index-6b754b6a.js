import{r as d,z as M,j as e,l as V,a0 as oe,a1 as le,d as k,f as b,a2 as J,P as ce,h as Y,L as de}from"./index-c77f71d3.js";import{a as me,u as ue}from"./useBookings-0af8e387.js";import{u as he}from"./useTechnicians-4e706579.js";import{u as xe}from"./useProducts-23bd0b56.js";import{F as a}from"./Form-02fdc037.js";import{A as z}from"./Alert-5ff5c802.js";import{S as _}from"./Spinner-57fd8da3.js";import{B as g}from"./Button-e558b3a0.js";import{M as E}from"./Modal-743fa430.js";import{g as je}from"./statusUtils-791fd5b0.js";import{a as pe}from"./hook-64fa6b32.js";import{u as ge,B as fe}from"./Nav-b5944bca.js";import{N as ve}from"./NavbarContext-4ac4437e.js";import{m as Ne}from"./NavContext-3dc3056d.js";import{B as $}from"./Badge-62eebc93.js";import{I as D}from"./InputGroup-b006216e.js";import{B as be}from"./ButtonGroup-b8c95997.js";import"./useQuery-1ca363b0.js";import"./useMutation-321b40d5.js";import"./AbstractModalHeader-f3c676a3.js";import"./useWindow-0e4dedaf.js";import"./hasClass-d7067b67.js";import"./useMergedRefs-b50dd209.js";import"./DataKey-e12315fd.js";import"./InputGroupContext-8f6f5b65.js";const Z=d.forwardRef(({className:i,bsPrefix:n,as:p="div",...h},o)=>(n=M(n,"nav-item"),e.jsx(p,{ref:o,className:V(i,n),...h})));Z.displayName="NavItem";const ye=Z,W=d.forwardRef(({bsPrefix:i,className:n,as:p=oe,active:h,eventKey:o,disabled:l=!1,...j},x)=>{i=M(i,"nav-link");const[f,m]=ge({key:Ne(o,j.href),active:h,disabled:l,...j});return e.jsx(p,{...j,...f,ref:x,disabled:l,className:V(n,i,l&&"disabled",m.isActive&&"active")})});W.displayName="NavLink";const Ce=W,X=d.forwardRef((i,n)=>{const{as:p="div",bsPrefix:h,variant:o,fill:l=!1,justify:j=!1,navbar:x,navbarScroll:f,className:m,activeKey:r,...c}=pe(i,{activeKey:"onSelect"}),u=M(h,"nav");let v,N,y=!1;const S=d.useContext(ve),w=d.useContext(le);return S?(v=S.bsPrefix,y=x??!0):w&&({cardHeaderBsPrefix:N}=w),e.jsx(fe,{as:p,ref:n,activeKey:r,className:V(m,{[u]:!y,[`${v}-nav`]:y,[`${v}-nav-scroll`]:y&&f,[`${N}-${o}`]:!!N,[`${u}-${o}`]:!!o,[`${u}-fill`]:l,[`${u}-justified`]:j}),...c})});X.displayName="Nav";const C=Object.assign(X,{Item:ye,Link:Ce});let G=!1,I=!1;const F=[],ke=({onPlaceSelected:i,value:n="",placeholder:p="Search for an address",required:h=!1})=>{const o=d.useRef(null),l=d.useRef(null);return d.useEffect(()=>{o.current&&n&&(o.current.value=n)},[n]),d.useEffect(()=>{const j="AIzaSyDJvwpR_epAanY-ayIYf8AZmjUu2IgFpdc",x=()=>{if(!o.current){setTimeout(x,100);return}if(!window.google||!window.google.maps||!window.google.maps.places){setTimeout(x,200);return}try{l.current&&google.maps.event.clearInstanceListeners(l.current);const m={types:["geocode","establishment"],componentRestrictions:{country:"vn"},fields:["formatted_address","geometry","name"]};l.current=new google.maps.places.Autocomplete(o.current,m),setTimeout(()=>{document.querySelector(".pac-container")},1e3),l.current.addListener("place_changed",()=>{var u;const r=(u=l.current)==null?void 0:u.getPlace();if(!r||!r.geometry||!r.geometry.location)return;const c={address:r.formatted_address||"",latitude:r.geometry.location.lat(),longitude:r.geometry.location.lng()};o.current&&(o.current.value=c.address),i(c)})}catch{}};return(()=>{if(G||window.google&&window.google.maps&&window.google.maps.places){G=!0,x();return}if(I){F.push(x);return}const m=document.querySelector('script[src*="maps.googleapis.com"]');if(m){I=!0,m.addEventListener("load",()=>{G=!0,I=!1,x(),F.forEach(u=>u()),F.length=0});return}const r=`https://maps.googleapis.com/maps/api/js?key=${j}&libraries=places`;I=!0;const c=document.createElement("script");c.src=r,c.async=!0,c.defer=!0,c.onload=()=>{G=!0,I=!1,x(),F.forEach(u=>u()),F.length=0},c.onerror=()=>{I=!1},document.head.appendChild(c)})(),()=>{if(l.current&&window.google&&window.google.maps)try{google.maps.event.clearInstanceListeners(l.current)}catch{}}},[i]),e.jsxs(e.Fragment,{children:[e.jsx("style",{children:`
				.pac-container {
					z-index: 9999 !important;
					position: fixed !important;
				}
			`}),e.jsx("div",{style:{position:"relative"},children:e.jsx(a.Control,{ref:o,type:"text",defaultValue:n,placeholder:p,required:h,autoComplete:"off",id:"google-places-autocomplete-input"})})]})},Se=({initialData:i,products:n,productsLoading:p=!1,onSubmit:h,onCancel:o,isSubmitting:l=!1,error:j,submitButtonText:x="Submit",cancelButtonText:f="Cancel",showCancelButton:m=!0})=>{const[r,c]=d.useState({bookingTime:"",customerId:"",customerName:"",customerPhone:"",latitude:0,longitude:0,address:"",items:[],...i}),[u,v]=d.useState(""),[N,y]=d.useState(1);d.useEffect(()=>{i&&(c(t=>({...t,...i})),i.items&&i.items.length>0&&(v(i.items[0].productId),y(i.items[0].quantity)))},[i]);const S=t=>{c(L=>({...L,address:t.address,latitude:t.latitude,longitude:t.longitude}))},w=t=>{if(t.preventDefault(),!u)return;const L={...r,bookingTime:r.bookingTime?new Date(r.bookingTime).toISOString():new Date().toISOString(),items:[{productId:u,quantity:N}]};h(L)},B=n.find(t=>t.id===u);return e.jsxs(a,{onSubmit:w,children:[j&&e.jsx(z,{variant:"danger",dismissible:!0,children:j}),e.jsxs(k,{children:[e.jsx(b,{md:6,children:e.jsxs(a.Group,{className:"mb-3",children:[e.jsx(a.Label,{children:"Customer Name *"}),e.jsx(a.Control,{type:"text",placeholder:"Enter customer name",value:r.customerName||"",onChange:t=>c({...r,customerName:t.target.value}),required:!0})]})}),e.jsx(b,{md:6,children:e.jsxs(a.Group,{className:"mb-3",children:[e.jsx(a.Label,{children:"Customer Phone *"}),e.jsx(a.Control,{type:"tel",placeholder:"0352978519",value:r.customerPhone||"",onChange:t=>c({...r,customerPhone:t.target.value}),required:!0})]})})]}),e.jsxs(a.Group,{className:"mb-3",children:[e.jsx(a.Label,{children:"Customer ID *"}),e.jsx(a.Control,{type:"text",placeholder:"Enter customer ID (UUID)",value:r.customerId||"",onChange:t=>c({...r,customerId:t.target.value}),required:!0})]}),e.jsxs(a.Group,{className:"mb-3",children:[e.jsx(a.Label,{children:"Address *"}),e.jsx(ke,{value:r.address||"",onPlaceSelected:S,placeholder:"Search for an address using Google Maps",required:!0})]}),r.latitude!==0&&r.longitude!==0&&e.jsx(z,{variant:"info",className:"mb-3",children:e.jsxs("small",{children:[e.jsx("strong",{children:"Coordinates:"})," ",r.latitude.toFixed(6),", ",r.longitude.toFixed(6)]})}),e.jsxs(a.Group,{className:"mb-3",children:[e.jsx(a.Label,{children:"Booking Time *"}),e.jsx(a.Control,{type:"datetime-local",value:r.bookingTime?new Date(r.bookingTime).toISOString().slice(0,16):"",onChange:t=>c({...r,bookingTime:t.target.value}),required:!0})]}),e.jsxs(k,{children:[e.jsx(b,{md:8,children:e.jsxs(a.Group,{className:"mb-3",children:[e.jsx(a.Label,{children:"Select Product *"}),p?e.jsxs("div",{className:"text-center py-2",children:[e.jsx(_,{animation:"border",size:"sm"}),e.jsx("span",{className:"ms-2",children:"Loading products..."})]}):e.jsxs(a.Select,{value:u,onChange:t=>v(t.target.value),required:!0,children:[e.jsx("option",{value:"",children:"-- Select a product --"}),n.map(t=>e.jsxs("option",{value:t.id,children:[t.name," - ",t.price.toLocaleString("vi-VN")," VND"]},t.id))]})]})}),e.jsx(b,{md:4,children:e.jsxs(a.Group,{className:"mb-3",children:[e.jsx(a.Label,{children:"Quantity *"}),e.jsx(a.Control,{type:"number",min:"1",value:N,onChange:t=>y(parseInt(t.target.value)||1),required:!0})]})})]}),B&&e.jsxs(z,{variant:"info",className:"mb-3",children:[e.jsx("strong",{children:"Selected:"})," ",B.name," x ",N,e.jsx("br",{}),e.jsx("small",{className:"text-muted",children:B.description}),e.jsx("hr",{className:"my-2"}),e.jsxs("strong",{children:["Total: ",(B.price*N).toLocaleString("vi-VN")," VND"]})]}),e.jsxs("div",{className:"d-flex gap-2 justify-content-end mt-3",children:[m&&o&&e.jsx(g,{type:"button",variant:"secondary",onClick:o,disabled:l,children:f}),e.jsx(g,{type:"submit",variant:"primary",disabled:l||!u||!r.address,children:l?e.jsxs(e.Fragment,{children:[e.jsx(_,{animation:"border",size:"sm",className:"me-2"}),"Submitting..."]}):x})]})]})},we=({show:i,onHide:n,onSuccess:p})=>{var f;const h=me(),{showNotification:o}=J(),{data:l=[],isLoading:j}=xe(),x=async m=>{try{await h.mutateAsync(m),o("Booking created successfully","success"),n(),p==null||p()}catch(r){o(r instanceof Error?r.message:"Failed to create booking","error")}};return e.jsxs(E,{show:i,onHide:n,size:"lg",children:[e.jsx(E.Header,{closeButton:!0,children:e.jsx(E.Title,{children:"Create New Booking"})}),e.jsx(E.Body,{children:e.jsx(Se,{products:l,productsLoading:j,onSubmit:x,onCancel:n,isSubmitting:h.isPending,error:h.isError?`Failed to create booking: ${((f=h.error)==null?void 0:f.message)||"Unknown error"}`:null,submitButtonText:"Create Booking",showCancelButton:!0})})]})};const Be=()=>{var U,H;const[i,n]=d.useState(1),[p]=d.useState(10),[h,o]=d.useState("new"),[l,j]=d.useState(""),[x,f]=d.useState(""),[m,r]=d.useState(""),[c,u]=d.useState(""),[v,N]=d.useState(""),[y,S]=d.useState(!1),{data:w=[]}=he();d.useEffect(()=>{const s=setTimeout(()=>{f(l),n(1)},500);return()=>clearTimeout(s)},[l]);const B=s=>s?new Date(s).toISOString():void 0,{data:t,isLoading:L,error:T,refetch:R}=ue({page:i,pageSize:p,status:[0,1,2,3,4,5,6,7,8],keyword:x||void 0,bookingFrom:B(m),bookingTo:B(c),technicianId:v||void 0}),{showNotification:P}=J();d.useEffect(()=>{T&&P(T instanceof Error?T.message:"Failed to load bookings","error")},[T,P]);const A={new:(t==null?void 0:t.totalCount)||0,verification:0,approval:0,processed:0},ee=()=>{R(),P("Bookings list refreshed","success")},q=s=>{s.preventDefault(),f(l),n(1)},O=()=>{j(""),f(""),n(1)},se=()=>{r(""),u(""),n(1)},K=()=>{n(1)},te=s=>{N(s),n(1)},re=()=>{N(""),n(1)},ae=()=>{j(""),f(""),r(""),u(""),N(""),n(1)},ne=l||m||c||v,ie=(t==null?void 0:t.items)||[];return e.jsxs(e.Fragment,{children:[e.jsx(ce,{title:"Booking Management",subName:"Apps"}),e.jsx(k,{children:e.jsx(b,{xs:12,children:e.jsx(Y,{children:e.jsxs(Y.Body,{children:[e.jsxs(C,{variant:"tabs",className:"nav-bordered mb-4",children:[e.jsx(C.Item,{children:e.jsxs(C.Link,{active:h==="new",onClick:()=>o("new"),className:"d-flex align-items-center gap-2",children:["New",A.new>0&&e.jsx($,{bg:"danger",className:"ms-1",children:A.new})]})}),e.jsx(C.Item,{children:e.jsxs(C.Link,{active:h==="verification",onClick:()=>o("verification"),className:"d-flex align-items-center gap-2",children:["Verification Due",A.verification>0]})}),e.jsx(C.Item,{children:e.jsxs(C.Link,{active:h==="approval",onClick:()=>o("approval"),className:"d-flex align-items-center gap-2",children:["Approval Due",A.approval>0]})}),e.jsx(C.Item,{children:e.jsxs(C.Link,{active:h==="processed",onClick:()=>o("processed"),className:"d-flex align-items-center gap-2",children:["Processed",A.processed>0]})})]}),e.jsx(k,{className:"mb-4",children:e.jsx(b,{md:12,children:e.jsxs(a,{onSubmit:q,children:[e.jsxs(D,{children:[e.jsx(D.Text,{children:e.jsx("i",{className:"mdi mdi-magnify"})}),e.jsx(a.Control,{type:"text",placeholder:"Search bookings by keyword (customer name, phone, address, code)...",value:l,onChange:s=>j(s.target.value),onKeyDown:s=>{s.key==="Enter"&&(s.preventDefault(),q(s))}}),l&&e.jsx(g,{variant:"outline-secondary",onClick:O,title:"Clear search",children:e.jsx("i",{className:"mdi mdi-close"})}),e.jsx(g,{variant:"primary",type:"submit",children:"Search"})]}),x&&e.jsx("div",{className:"mt-2",children:e.jsxs("small",{className:"text-muted",children:["Searching for: ",e.jsxs("strong",{children:['"',x,'"']})," ",e.jsx(g,{variant:"link",size:"sm",className:"p-0 ms-2",onClick:O,children:"Clear"})]})})]})})}),e.jsxs(k,{className:"mb-4",children:[e.jsx(b,{md:6,children:e.jsxs(a.Group,{children:[e.jsxs(a.Label,{children:[e.jsx("i",{className:"mdi mdi-calendar-start me-1"}),"Booking From"]}),e.jsx(a.Control,{type:"datetime-local",value:m,onChange:s=>{r(s.target.value),K()}})]})}),e.jsx(b,{md:6,children:e.jsxs(a.Group,{children:[e.jsxs(a.Label,{children:[e.jsx("i",{className:"mdi mdi-calendar-end me-1"}),"Booking To"]}),e.jsxs(D,{children:[e.jsx(a.Control,{type:"datetime-local",value:c,onChange:s=>{u(s.target.value),K()}}),(m||c)&&e.jsx(g,{variant:"outline-secondary",onClick:se,title:"Clear date filter",children:e.jsx("i",{className:"mdi mdi-close"})})]})]})})]}),(m||c)&&e.jsx(k,{className:"mb-3",children:e.jsx(b,{md:12,children:e.jsxs("small",{className:"text-muted",children:["Date filter: ",e.jsxs("strong",{children:[m?new Date(m).toLocaleString("vi-VN"):"Any"," â†’ ",c?new Date(c).toLocaleString("vi-VN"):"Any"]})]})})}),e.jsx(k,{className:"mb-4",children:e.jsx(b,{md:6,children:e.jsxs(a.Group,{children:[e.jsxs(a.Label,{children:[e.jsx("i",{className:"mdi mdi-account-wrench me-1"}),"Filter by Technician"]}),e.jsxs(D,{children:[e.jsxs(a.Select,{value:v,onChange:s=>te(s.target.value),children:[e.jsx("option",{value:"",children:"All Technicians"}),w.map(s=>e.jsxs("option",{value:s.id,children:[s.name," ",s.phone?`(${s.phone})`:""]},s.id))]}),v&&e.jsx(g,{variant:"outline-secondary",onClick:re,title:"Clear technician filter",children:e.jsx("i",{className:"mdi mdi-close"})})]}),v&&e.jsxs(a.Text,{className:"text-muted",children:["Showing bookings for: ",e.jsx("strong",{children:((U=w.find(s=>s.id===v))==null?void 0:U.name)||"Selected Technician"})]})]})})}),e.jsx(k,{className:"mb-4",children:e.jsx(b,{xs:12,children:e.jsxs(be,{className:"mb-2 gap-1",children:[e.jsxs(g,{variant:"primary",size:"sm",onClick:()=>S(!0),children:[e.jsx("i",{className:"mdi mdi-plus me-1"}),"Create Booking"]}),e.jsxs(g,{variant:"secondary",size:"sm",onClick:async()=>{try{await R(),P("Bookings list refreshed","success")}catch(s){P(s instanceof Error?s.message:"Failed to refresh bookings","error")}},children:[e.jsx("i",{className:"mdi mdi-refresh me-1"}),"Reload"]}),ne&&e.jsxs(g,{variant:"outline-danger",size:"sm",onClick:ae,title:"Clear all filters",children:[e.jsx("i",{className:"mdi mdi-filter-remove me-1"}),"Clear All Filters"]})]})})}),T&&e.jsxs(z,{variant:"danger",children:[e.jsx("strong",{children:"Error:"})," ",T instanceof Error?T.message:"Failed to load bookings"]}),L?e.jsxs("div",{className:"text-center py-5",children:[e.jsx(_,{animation:"border",variant:"primary"}),e.jsx("p",{className:"mt-2",children:"Loading bookings..."})]}):t!=null&&t.items&&t.items.length>0?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-centered table-striped table-hover",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Booking Code"}),e.jsx("th",{children:"Customer Name"}),e.jsx("th",{children:"Phone"}),e.jsx("th",{children:"Address"}),e.jsx("th",{children:"Booking Time"}),e.jsx("th",{children:"Items"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Technician"}),e.jsx("th",{children:"Created At"}),e.jsx("th",{className:"booking-actions-column",children:"Actions"})]})}),e.jsx("tbody",{children:ie.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("code",{className:"text-primary",children:s.code||s.id.substring(0,8)})}),e.jsx("td",{children:e.jsx("strong",{children:s.customerName||"N/A"})}),e.jsx("td",{children:s.customerPhone||"-"}),e.jsx("td",{className:"text-muted",children:e.jsx("small",{children:s.address||"-"})}),e.jsx("td",{children:new Date(s.bookingTime).toLocaleString("vi-VN")}),e.jsx("td",{children:s.items&&s.items.length>0?e.jsxs($,{bg:"info",children:[s.items.length," items"]}):s.totalPrice?e.jsxs($,{bg:"secondary",children:[s.totalPrice.toLocaleString("vi-VN")," VND"]}):e.jsx("span",{className:"text-muted",children:"-"})}),e.jsx("td",{children:je(s.status)}),e.jsx("td",{children:s.technicianName?e.jsx("span",{children:s.technicianName}):e.jsx("span",{className:"text-muted",children:"-"})}),e.jsx("td",{children:s.createdAt?new Date(s.createdAt).toLocaleString("vi-VN"):"-"}),e.jsx("td",{className:"booking-actions-column",children:e.jsx(de,{to:`/apps/booking/${s.id}`,children:e.jsxs(g,{variant:"outline-primary",size:"sm",onClick:Q=>Q.stopPropagation(),children:[e.jsx("i",{className:"mdi mdi-eye me-1"}),"View"]})})})]},s.id))})]})}),e.jsx(k,{className:"mt-4",children:e.jsx(b,{xs:12,children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{className:"text-muted",children:["Showing ",((H=t.items)==null?void 0:H.length)||0," of ",t.totalCount," bookings"]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx(g,{variant:"secondary",size:"sm",disabled:i===1,onClick:()=>n(i-1),children:"Previous"}),e.jsxs(g,{variant:"secondary",size:"sm",disabled:!0,children:["Page ",i," of ",t.totalPages]}),e.jsx(g,{variant:"secondary",size:"sm",disabled:i>=t.totalPages,onClick:()=>n(i+1),children:"Next"})]})]})})})]}):e.jsxs("div",{className:"text-center py-5",children:[e.jsx("p",{className:"text-muted",children:"No bookings found"}),e.jsx(g,{variant:"primary",onClick:()=>S(!0),children:"Create First Booking"})]})]})})})}),e.jsx(we,{show:y,onHide:()=>S(!1),onSuccess:ee})]})},Xe=()=>e.jsx(Be,{});export{Xe as default};
