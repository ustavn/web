import{o as G,U as $,a7 as O,j as e,r as p,P as X,d as E,f as N,h as H,X as Z}from"./index-7abc2e1c.js";import{u as D}from"./useQuery-fef0428f.js";import{u as U}from"./useMutation-04d1b243.js";import{u as W}from"./useShifts-5696a0cc.js";import{B as Y}from"./ButtonGroup-9fb69fa0.js";import{B as v}from"./Button-98115848.js";import{S}from"./Spinner-f490c646.js";import{B as j}from"./Badge-f7a378fe.js";import{F as R}from"./Form-3dd09149.js";import{A as V}from"./Alert-970a7765.js";import{M as A}from"./Modal-d1b37a71.js";import{T as ee}from"./Table-2e1e6572.js";import"./FormControl-92329ab5.js";import"./ElementChildren-dbbb72ab.js";import"./hook-87ee9a06.js";import"./AbstractModalHeader-b51e44f5.js";import"./useWindow-25e16477.js";import"./hasClass-d6dc9e47.js";import"./useMergedRefs-c0c7f279.js";import"./DataKey-e12315fd.js";const se="https://api.dev.usta.vn",y=G.create({baseURL:`${se}/api`,timeout:3e4,headers:{"Content-Type":"application/json"}});y.interceptors.request.use(async s=>{const n=localStorage.getItem("_USTA_OAUTH");if(n)try{const a=JSON.parse(n);s.headers.Authorization=`Bearer ${a.accessToken}`,console.log("[Technician API] Request:",{method:s.method,url:s.url,params:s.params,hasAuth:!!s.headers.Authorization})}catch(a){console.error("[Technician API] Failed to parse OAuth session:",a)}else console.warn("[Technician API] No OAuth session found");return s},s=>(console.error("[Technician API] Request error:",s),Promise.reject(s)));y.interceptors.response.use(s=>(console.log("[Technician API] Response:",{status:s.status,url:s.config.url,data:s.data}),s),s=>{var n,a,i;return console.error("[Technician API] Response error:",{status:(n=s.response)==null?void 0:n.status,url:(a=s.config)==null?void 0:a.url,data:(i=s.response)==null?void 0:i.data,message:s.message}),Promise.reject(s)});async function te(s={}){console.log("[Technician API] Fetching technicians:",s);const n=await y.get("/technicians/",{params:s});if(n.data.success)return n.data.data;throw new Error(n.data.error||"Failed to fetch technicians")}async function ne(s){console.log("[Technician API] Fetching technician by ID:",s);const n=await y.get(`/technicians/${s}`);if(n.data&&typeof n.data=="object"&&"success"in n.data){const a=n.data;if(a.success&&a.data)return a.data;throw new Error(a.error||"Failed to fetch technician")}return n.data}async function ae(s){var n,a,i,u;console.log("[Technician API] Approving technician:",s);try{const{technicianId:o,...r}=s,l=await y.post(`/technicians/${o}/approve`,r);if(l.data.success&&l.data.data)return l.data.data;throw new Error(l.data.error||l.data.message||"Failed to approve technician")}catch(o){console.error("[Technician API] Error approving technician:",o);const r=((a=(n=o.response)==null?void 0:n.data)==null?void 0:a.error)||((u=(i=o.response)==null?void 0:i.data)==null?void 0:u.message)||o.message||"Failed to approve technician";throw new Error(r)}}async function ie(s){var n,a,i,u;console.log("[Technician API] Rejecting technician:",s);try{const{technicianId:o,reason:r}=s,l=await y.post(`/technicians/${o}/reject`,{reason:r});if(!l.data.success)throw new Error(l.data.error||l.data.message||"Failed to reject technician")}catch(o){console.error("[Technician API] Error rejecting technician:",o);const r=((a=(n=o.response)==null?void 0:n.data)==null?void 0:a.error)||((u=(i=o.response)==null?void 0:i.data)==null?void 0:u.message)||o.message||"Failed to reject technician";throw new Error(r)}}async function re(s,n={}){var a,i,u,o;console.log("[Technician API] Fetching technician shifts:",{technicianId:s,params:n});try{const r=await y.post(`/technician-shifts/${s}`,n);if(r.data.success&&r.data.data)return r.data.data.items||[];throw new Error(r.data.error||"Failed to fetch technician shifts")}catch(r){console.error("[Technician API] Error fetching technician shifts:",r);const l=((i=(a=r.response)==null?void 0:a.data)==null?void 0:i.error)||((o=(u=r.response)==null?void 0:u.data)==null?void 0:o.message)||r.message||"Failed to fetch technician shifts";throw new Error(l)}}function ce(s={}){return D({queryKey:["technicians",s],queryFn:()=>te(s),staleTime:3e4,retry:2,select:n=>n||[]})}function oe(s){return D({queryKey:["technician",s],queryFn:()=>ne(s),enabled:!!s,staleTime:3e4})}function le(){const s=$(),{showNotification:n}=O();return U({mutationFn:a=>ae(a),onSuccess:()=>{s.invalidateQueries({queryKey:["technicians"]}),n({message:"Technician approved successfully",type:"success"})},onError:a=>{const i=(a==null?void 0:a.message)||"Failed to approve technician";n({message:i,type:"error"})}})}function de(){const s=$(),{showNotification:n}=O();return U({mutationFn:a=>ie(a),onSuccess:()=>{s.invalidateQueries({queryKey:["technicians"]}),n({message:"Technician rejected successfully",type:"success"})},onError:a=>{const i=(a==null?void 0:a.message)||"Failed to reject technician";n({message:i,type:"error"})}})}function he(s,n={},a=!0){return D({queryKey:["technician-shifts",s,n],queryFn:()=>re(s,n),enabled:!!s&&a,staleTime:3e4,retry:2,select:i=>i||[]})}const me=({onApprove:s,onReject:n,onViewDetail:a,processingId:i,isApproving:u,isRejecting:o,needsApproval:r,getStatusBadge:l,getRatingStars:b})=>[{Header:"Name",accessor:"name",defaultCanSort:!0,Cell:({row:m})=>{const h=m.original;return e.jsxs("div",{children:[e.jsx("strong",{children:h.name}),h.address&&e.jsx("div",{className:"text-muted small",children:h.address})]})}},{Header:"Phone",accessor:"phone",defaultCanSort:!0},{Header:"Email",accessor:"email",defaultCanSort:!0,Cell:({value:m})=>m||e.jsx("span",{className:"text-muted",children:"-"})},{Header:"Specialization",accessor:"specialization",defaultCanSort:!1,Cell:({value:m})=>m||e.jsx("span",{className:"text-muted",children:"-"})},{Header:"Rating",accessor:"rating",defaultCanSort:!0,Cell:({row:m})=>{const h=m.original;return b(h.rating)}},{Header:"Status",accessor:"status",defaultCanSort:!0,Cell:({row:m})=>{const h=m.original;return l(h.status)}},{Header:"Created At",accessor:"createdAt",defaultCanSort:!0,Cell:({value:m})=>new Date(m).toLocaleDateString("vi-VN")},{Header:"Actions",accessor:"id",defaultCanSort:!1,Cell:({row:m})=>{const h=m.original,g=i===h.id,c=r(h);return e.jsx("div",{className:"d-flex gap-1",children:e.jsxs(Y,{size:"sm",className:"gap-1",children:[e.jsx(v,{variant:"info",onClick:f=>{f.stopPropagation(),a(h)},title:"View Details",children:e.jsx("i",{className:"mdi mdi-eye"})}),c&&e.jsxs(e.Fragment,{children:[e.jsx(v,{variant:"success",onClick:f=>{f.stopPropagation(),s(h)},disabled:g,title:"Approve",children:g&&u?e.jsxs(e.Fragment,{children:[e.jsx(S,{animation:"border",size:"sm",className:"me-1"}),"Approving..."]}):"Approve"}),e.jsx(v,{variant:"danger",onClick:f=>{f.stopPropagation(),n(h)},disabled:g,title:"Reject",children:g&&o?e.jsxs(e.Fragment,{children:[e.jsx(S,{animation:"border",size:"sm",className:"me-1"}),"Rejecting..."]}):"Reject"})]})]})})}}],ue=[{text:"10",value:10},{text:"25",value:25},{text:"50",value:50},{text:"100",value:100}],pe=()=>{const[s,n]=p.useState(void 0),[a,i]=p.useState(null),[u,o]=p.useState(null),[r,l]=p.useState(!1),{data:b=[],isLoading:m,error:h,refetch:g}=ce(s!==void 0?{status:s}:{}),{data:c,isLoading:f,error:k}=oe(u||""),K=p.useMemo(()=>{const t=new Date;return t.setDate(t.getDate()-30),{from:t.toISOString(),page:1,pageSize:100}},[r]),{data:M=[],isLoading:Q}=he(u||"",K,r),{data:J=[]}=W({}),T=le(),w=de(),P=p.useCallback(t=>{switch(t){case 1:return e.jsx(j,{bg:"info",children:"Pending"});case 2:return e.jsx(j,{bg:"success",children:"Approved"});case 3:return e.jsx(j,{bg:"danger",children:"Rejected"});default:return e.jsx(j,{bg:"secondary",children:"Unknown"})}},[]),C=p.useCallback(t=>t.status===1,[]),z=p.useCallback(async t=>{if(!C(t))return;const d=t.name||t.phone||t.id||"this technician";if(window.confirm(`Are you sure you want to approve ${d}?`)){i(t.id);try{await T.mutateAsync({technicianId:t.id,profileId:t.profileId,skills:t.skills,zones:t.zones})}catch(x){console.error("Failed to approve technician:",x)}finally{i(null)}}},[C,T]),L=p.useCallback(async t=>{const d=t.name||t.phone||t.id||"this technician",x=window.prompt(`Enter reason for rejecting ${d} (optional):`);if(x!==null&&window.confirm(`Are you sure you want to reject ${d}?`)){i(t.id);try{await w.mutateAsync({technicianId:t.id,reason:x||void 0})}catch(I){console.error("Failed to reject technician:",I)}finally{i(null)}}},[w]),F=p.useCallback(t=>{if(!t)return e.jsx("span",{className:"text-muted",children:"No rating"});const d="â­".repeat(Math.round(t));return e.jsxs("span",{children:[d," (",t.toFixed(1),")"]})},[]),q=p.useCallback(t=>{o(t.id),l(!0)},[]),B=p.useCallback(()=>{l(!1),o(null)},[]),_=p.useMemo(()=>me({onApprove:z,onReject:L,onViewDetail:q,processingId:a,isApproving:T.isPending,isRejecting:w.isPending,needsApproval:C,getStatusBadge:P,getRatingStars:F}),[z,L,q,a,T.isPending,w.isPending,C,P,F]);return e.jsxs(e.Fragment,{children:[e.jsx(X,{title:"Technician Management",subName:"Apps"}),e.jsx(E,{children:e.jsx(N,{xs:12,children:e.jsx(H,{children:e.jsxs(H.Body,{children:[e.jsx(E,{className:"mb-3",children:e.jsx(N,{md:4,children:e.jsxs(R.Group,{children:[e.jsx(R.Label,{children:"Filter by Status"}),e.jsxs(R.Select,{value:s??"",onChange:t=>{const d=t.target.value;n(d===""?void 0:Number(d))},children:[e.jsx("option",{value:"",children:"All"}),e.jsx("option",{value:1,children:"Pending"}),e.jsx("option",{value:2,children:"Approved"}),e.jsx("option",{value:3,children:"Rejected"})]})]})})}),h&&e.jsxs(V,{variant:"danger",dismissible:!0,children:["Failed to load technicians: ",h.message,e.jsx(v,{variant:"link",onClick:()=>g(),children:"Try Again"})]}),m?e.jsxs("div",{className:"text-center py-5",children:[e.jsx(S,{animation:"border",variant:"primary"}),e.jsx("p",{className:"mt-2",children:"Loading technicians..."})]}):b&&b.length>0?e.jsx(Z,{columns:_,data:b,pageSize:10,sizePerPageList:ue,isSortable:!0,pagination:!0,isSearchable:!0,theadClass:"table-light"}):e.jsxs("div",{className:"text-center py-5",children:[e.jsx("p",{className:"text-muted",children:"No technicians found"}),e.jsx(v,{variant:"link",onClick:()=>g(),children:"Try Again"})]})]})})})}),e.jsxs(A,{show:r,onHide:B,size:"lg",children:[e.jsx(A.Header,{closeButton:!0,children:e.jsx(A.Title,{children:"Technician Details"})}),e.jsx(A.Body,{children:f?e.jsxs("div",{className:"text-center py-5",children:[e.jsx(S,{animation:"border",variant:"primary"}),e.jsx("p",{className:"mt-2",children:"Loading technician details..."})]}):k?e.jsxs(V,{variant:"danger",children:["Failed to load technician details: ",k.message,e.jsx("div",{className:"mt-2",children:e.jsx(v,{variant:"link",size:"sm",onClick:()=>l(!1),children:"Close"})})]}):c?e.jsxs(E,{children:[e.jsxs(N,{md:6,children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Name:"}),e.jsx("p",{className:"mb-0",children:c.name})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Phone:"}),e.jsx("p",{className:"mb-0",children:c.phone})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Email:"}),e.jsx("p",{className:"mb-0",children:c.email||e.jsx("span",{className:"text-muted",children:"-"})})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Address:"}),e.jsx("p",{className:"mb-0",children:c.address||e.jsx("span",{className:"text-muted",children:"-"})})]})]}),e.jsxs(N,{md:6,children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Status:"}),e.jsx("p",{className:"mb-0",children:P(c.status)})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Specialization:"}),e.jsx("p",{className:"mb-0",children:c.specialization||e.jsx("span",{className:"text-muted",children:"-"})})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Rating:"}),e.jsx("p",{className:"mb-0",children:F(c.rating)})]}),c.updatedAt&&e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Updated At:"}),e.jsx("p",{className:"mb-0",children:new Date(c.updatedAt).toLocaleDateString("vi-VN",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})})]})]}),c.profileId&&e.jsxs(N,{xs:12,children:[e.jsx("hr",{}),e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Profile ID:"}),e.jsx("p",{className:"mb-0 text-muted small",children:c.profileId})]}),c.skills&&c.skills.length>0&&e.jsxs("div",{className:"mb-2",children:[e.jsxs("strong",{children:["Skills (",c.skills.length,"):"]}),e.jsx("div",{className:"mt-1",children:c.skills.map((t,d)=>{const x=typeof t=="string"?t:(t==null?void 0:t.name)||JSON.stringify(t);return e.jsx(j,{bg:"primary",className:"me-1",children:x},d)})})]}),c.zones&&c.zones.length>0&&e.jsxs("div",{className:"mb-2",children:[e.jsxs("strong",{children:["Zones (",c.zones.length,"):"]}),e.jsx("div",{className:"mt-1",children:c.zones.map((t,d)=>{const x=typeof t=="string"?t:(t==null?void 0:t.name)||JSON.stringify(t);return e.jsx(j,{bg:"info",className:"me-1",children:x},d)})})]})]}),e.jsxs(N,{xs:12,children:[e.jsx("hr",{className:"my-3"}),e.jsx("h6",{className:"mb-3",children:"Shifts"}),Q?e.jsxs("div",{className:"text-center py-3",children:[e.jsx(S,{animation:"border",size:"sm",variant:"primary"}),e.jsx("p",{className:"mt-2 mb-0 small text-muted",children:"Loading shifts..."})]}):M.length>0?e.jsx("div",{className:"table-responsive",children:e.jsxs(ee,{striped:!0,bordered:!0,hover:!0,size:"sm",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Shift Name"}),e.jsx("th",{children:"Effective From"}),e.jsx("th",{children:"Effective To"}),e.jsx("th",{children:"Status"})]})}),e.jsx("tbody",{children:M.map(t=>{const d=J.find(I=>I.id===t.shiftId),x=(d==null?void 0:d.name)||t.shiftId;return e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx(j,{bg:"primary",children:x})}),e.jsx("td",{children:new Date(t.effectiveFrom).toLocaleDateString("vi-VN",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}),e.jsx("td",{children:new Date(t.effectiveTo).toLocaleDateString("vi-VN",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}),e.jsx("td",{children:t.isActive?e.jsx(j,{bg:"success",children:"Active"}):e.jsx(j,{bg:"secondary",children:"Inactive"})})]},t.id)})})]})}):e.jsx("p",{className:"text-muted small mb-0",children:"No shifts assigned"})]})]}):null}),e.jsx(A.Footer,{children:e.jsx(v,{variant:"secondary",onClick:B,children:"Close"})})]})]})},Me=()=>e.jsx(pe,{});export{Me as default};
