import{a6 as Y,a as q,r as d,a5 as $,j as e,P as w,d as k,f as M,h as x}from"./index-ce6fbccf.js";import{b as U,c as V}from"./useZones-0fa9b8f4.js";import{A as f}from"./Alert-d71e2039.js";import{S as E}from"./Spinner-11146b06.js";import{B as z}from"./Button-6ed85f28.js";import{B as L}from"./Badge-47045485.js";import"./useQuery-f1edf008.js";import"./useMutation-67ca3026.js";import"./hook-f4f2e89f.js";const te=()=>{const{id:j}=Y(),G=q(),v=d.useRef(null),y=d.useRef(null),b=d.useRef(null),o=d.useRef(null),[m,h]=d.useState(null),[Z,r]=d.useState(""),[P,p]=d.useState(""),{data:s,isLoading:F,error:N,refetch:O}=U(j||""),A=V(),{showNotification:S}=$();d.useEffect(()=>{const g="AIzaSyDJvwpR_epAanY-ayIYf8AZmjUu2IgFpdc";if(!v.current)return;const l=()=>{if(!window.google||!window.google.maps){console.log("[ZoneDetail] Waiting for Google Maps to load..."),setTimeout(l,100);return}try{const t=s!=null&&s.zoneAreas&&s.zoneAreas.length>0?{lat:s.zoneAreas[0].latitude,lng:s.zoneAreas[0].longitude}:{lat:10.762622,lng:106.660172},n=new window.google.maps.Map(v.current,{center:t,zoom:s!=null&&s.zoneAreas&&s.zoneAreas.length>0?15:13,mapTypeControl:!0,streetViewControl:!0,fullscreenControl:!0});if(y.current=n,!window.google.maps.drawing){r("Google Maps Drawing library is not available. Please ensure billing is enabled for your Google Maps API key and the drawing library is included.");return}const c=new window.google.maps.drawing.DrawingManager({drawingMode:null,drawingControl:!0,drawingControlOptions:{position:window.google.maps.ControlPosition.TOP_CENTER,drawingModes:[window.google.maps.drawing.OverlayType.POLYGON]},polygonOptions:{fillColor:"#4285F4",fillOpacity:.35,strokeWeight:2,clickable:!1,editable:!0,zIndex:1}});c.setMap(n),b.current=c,c.addListener("overlaycomplete",D=>{if(D.type===window.google.maps.drawing.OverlayType.POLYGON)try{o.current&&(o.current.setMap(null),window.google.maps.event.clearInstanceListeners(o.current));const i=D.overlay;o.current=i;const B=i.getPath(),C=[];if(B.forEach(I=>{C.push({lat:I.lat(),lng:I.lng()})}),C.length<3){r("Polygon must have at least 3 points");return}const T={id:Date.now().toString(),coordinates:C};h(T),r(""),p('Polygon drawn successfully. Click "Save Zone Area" to save.'),i.addListener("set_at",()=>{u(i)}),i.addListener("insert_at",()=>{u(i)}),i.addListener("remove_at",()=>{u(i)})}catch(i){console.error("[ZoneDetail] Error processing polygon:",i),r(`Error processing polygon: ${i}`)}})}catch(t){console.error("[ZoneDetail] Error initializing map:",t);const n=(t==null?void 0:t.message)||String(t);n.includes("BillingNotEnabled")||n.includes("billing")?r("Google Maps requires billing to be enabled in your Google Cloud Console."):r(`Failed to initialize map: ${n}`)}};return(()=>{if(window.google&&window.google.maps&&window.google.maps.drawing){l();return}if(document.querySelector('script[src*="maps.googleapis.com"]')){const c=setInterval(()=>{window.google&&window.google.maps&&window.google.maps.drawing&&(clearInterval(c),l())},100);return}const n=document.createElement("script");n.src=`https://maps.googleapis.com/maps/api/js?key=${g}&libraries=drawing,places&callback=initGoogleMapsZoneDetail`,n.async=!0,n.defer=!0,n.onerror=()=>{r("Failed to load Google Maps script")},window.initGoogleMapsZoneDetail=()=>{l()},document.head.appendChild(n)})(),()=>{var t,n;o.current&&((t=window.google)!=null&&t.maps)&&(window.google.maps.event.clearInstanceListeners(o.current),o.current.setMap(null)),b.current&&((n=window.google)!=null&&n.maps)&&window.google.maps.event.clearInstanceListeners(b.current)}},[s]),d.useEffect(()=>{var g;if(s!=null&&s.zoneAreas&&s.zoneAreas.length>0&&y.current&&((g=window.google)!=null&&g.maps)){o.current&&(o.current.setMap(null),window.google.maps.event.clearInstanceListeners(o.current));const l=s.zoneAreas.sort((n,c)=>n.orderNumber-c.orderNumber).map(n=>({lat:n.latitude,lng:n.longitude})),a=new window.google.maps.Polygon({paths:l,fillColor:"#4285F4",fillOpacity:.35,strokeWeight:2,clickable:!1,editable:!0,zIndex:1});a.setMap(y.current),o.current=a;const t=s.zoneAreas.sort((n,c)=>n.orderNumber-c.orderNumber).map(n=>({lat:n.latitude,lng:n.longitude}));h({id:Date.now().toString(),coordinates:t}),a.addListener("set_at",()=>{u(a)}),a.addListener("insert_at",()=>{u(a)}),a.addListener("remove_at",()=>{u(a)}),p("Existing zone area loaded. You can edit it by dragging the points.")}else s&&(!s.zoneAreas||s.zoneAreas.length===0)&&(o.current&&(o.current.setMap(null),window.google.maps.event.clearInstanceListeners(o.current),o.current=null),h(null))},[s]);const u=g=>{const l=g.getPath(),a=[];l.forEach(t=>{a.push({lat:t.lat(),lng:t.lng()})}),h({id:Date.now().toString(),coordinates:a})},R=()=>{o.current&&(o.current.setMap(null),window.google.maps.event.clearInstanceListeners(o.current),o.current=null),h(null),p("")},_=async()=>{if(!j||!s){r("Zone ID is required");return}if(!m||m.coordinates.length<3){r("Please draw a polygon with at least 3 points");return}r(""),p("");const g=m.coordinates.map((a,t)=>({orderNumber:t+1,latitude:a.lat,longitude:a.lng})),l={id:s.id,name:s.name,code:s.code,postCode:s.postCode,description:s.description,parentId:s.parentId,isActive:s.isActive??!0,zoneAreas:g};try{await A.mutateAsync({id:s.id,data:l}),p("Zone area saved successfully!"),S({message:"Zone area saved successfully",type:"success"}),await O()}catch(a){console.error("[ZoneDetail] Save error:",a);const t=(a==null?void 0:a.message)||"Failed to save zone area";r(t),S({message:t,type:"error"})}};return j?F?e.jsxs(e.Fragment,{children:[e.jsx(w,{title:"Zone Detail",subName:"Apps"}),e.jsxs("div",{className:"text-center py-5",children:[e.jsx(E,{animation:"border",variant:"primary"}),e.jsx("p",{className:"mt-2",children:"Loading zone details..."})]})]}):N||!s?e.jsxs(e.Fragment,{children:[e.jsx(w,{title:"Zone Detail",subName:"Apps"}),e.jsx(f,{variant:"danger",children:N?`Failed to load zone: ${N.message}`:"Zone not found"})]}):e.jsxs(e.Fragment,{children:[e.jsx(w,{title:"Zone Detail",subName:"Apps"}),e.jsx(k,{className:"mb-3",children:e.jsx(M,{children:e.jsxs(z,{variant:"secondary",onClick:()=>G("/apps/zones"),children:[e.jsx("i",{className:"mdi mdi-arrow-left me-1"})," Back to Zones"]})})}),e.jsxs(k,{children:[e.jsx(M,{lg:4,children:e.jsx(x,{children:e.jsxs(x.Body,{children:[e.jsx("h5",{className:"card-title mb-3",children:"Zone Information"}),e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Code:"})," ",s.code]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Name:"})," ",s.name]}),s.description&&e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Description:"})," ",s.description]}),s.postCode&&e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Post Code:"})," ",s.postCode]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Status:"})," ",s.isActive!==void 0?s.isActive?e.jsx(L,{bg:"success",children:"Active"}):e.jsx(L,{bg:"secondary",children:"Inactive"}):e.jsx("span",{className:"text-muted",children:"-"})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Created At:"})," ",new Date(s.createdAt).toLocaleString("vi-VN")]}),s.updatedAt&&e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Updated At:"})," ",new Date(s.updatedAt).toLocaleString("vi-VN")]}),s.zoneAreas&&s.zoneAreas.length>0&&e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Zone Areas:"})," ",s.zoneAreas.length," points"]})]})})}),e.jsx(M,{lg:8,children:e.jsx(x,{children:e.jsxs(x.Body,{children:[e.jsxs("h5",{className:"card-title mb-3",children:[e.jsx("i",{className:"mdi mdi-map-marker-path me-1"})," Geo Fence"]}),e.jsx("p",{className:"text-muted mb-3",children:"Click on the polygon icon in the map toolbar to start drawing. Click on the map to place points and double-click to finish."}),Z&&e.jsxs(f,{variant:"danger",dismissible:!0,onClose:()=>r(""),children:[e.jsx("i",{className:"mdi mdi-alert-circle me-2"}),Z]}),P&&e.jsxs(f,{variant:"success",dismissible:!0,onClose:()=>p(""),children:[e.jsx("i",{className:"mdi mdi-check-circle me-2"}),P]}),e.jsx("div",{ref:v,style:{width:"100%",height:"500px",borderRadius:"8px",border:"1px solid #dee2e6",marginBottom:"1rem"}}),m&&e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsxs("h6",{className:"mb-0",children:["Area (",m.coordinates.length," points)"]}),e.jsxs(z,{variant:"danger",size:"sm",onClick:R,children:[e.jsx("i",{className:"mdi mdi-delete me-1"})," Clear marked area"]})]}),e.jsx("div",{className:"text-end",children:e.jsx(z,{variant:"success",onClick:_,disabled:!m||A.isPending,children:A.isPending?e.jsxs(e.Fragment,{children:[e.jsx(E,{size:"sm",className:"me-2"}),"Saving..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"mdi mdi-content-save me-1"})," Save Zone Area"]})})})]})})})]})]}):e.jsxs(e.Fragment,{children:[e.jsx(w,{title:"Zone Detail",subName:"Apps"}),e.jsx(f,{variant:"danger",children:"Zone ID is required"})]})};export{te as default};
